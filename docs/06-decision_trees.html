<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; Decision Trees – Supervised Machine Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./07-support_vector_machines.html" rel="next">
<link href="./05-regularization.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06-decision_trees.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Decision Trees</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Supervised Machine Learning</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Ordinary Least Squares</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-generalized_linear_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Generalized Linear Models (GLM)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-linear_mixed_effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Mixed Effects Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-nonlinear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Non-linear Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regularization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-decision_trees.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Decision Trees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-support_vector_machines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Support Vector Machines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-bayesian_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Bayesian Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-emmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Estimated Marginal Means</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#classification-tree" id="toc-classification-tree" class="nav-link active" data-scroll-target="#classification-tree"><span class="header-section-number">6.1</span> Classification Tree</a>
  <ul>
  <li><a href="#measuring-performance" id="toc-measuring-performance" class="nav-link" data-scroll-target="#measuring-performance">Measuring Performance</a>
  <ul class="collapse">
  <li><a href="#confusion-matrix" id="toc-confusion-matrix" class="nav-link" data-scroll-target="#confusion-matrix">Confusion Matrix</a></li>
  <li><a href="#roc-curve" id="toc-roc-curve" class="nav-link" data-scroll-target="#roc-curve">ROC Curve</a></li>
  <li><a href="#gain-curve" id="toc-gain-curve" class="nav-link" data-scroll-target="#gain-curve"><span class="header-section-number">6.1.0.1</span> Gain Curve</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#regression-tree" id="toc-regression-tree" class="nav-link" data-scroll-target="#regression-tree"><span class="header-section-number">6.2</span> Regression Tree</a>
  <ul>
  <li><a href="#measuring-performance-1" id="toc-measuring-performance-1" class="nav-link" data-scroll-target="#measuring-performance-1">Measuring Performance</a></li>
  </ul></li>
  <li><a href="#bagged-trees" id="toc-bagged-trees" class="nav-link" data-scroll-target="#bagged-trees"><span class="header-section-number">6.3</span> Bagged Trees</a>
  <ul>
  <li><a href="#bagged-classification-tree" id="toc-bagged-classification-tree" class="nav-link" data-scroll-target="#bagged-classification-tree"><span class="header-section-number">6.3.1</span> Bagged Classification Tree</a></li>
  <li><a href="#bagging-regression-tree" id="toc-bagging-regression-tree" class="nav-link" data-scroll-target="#bagging-regression-tree"><span class="header-section-number">6.3.2</span> Bagging Regression Tree</a></li>
  </ul></li>
  <li><a href="#random-forests" id="toc-random-forests" class="nav-link" data-scroll-target="#random-forests"><span class="header-section-number">6.4</span> Random Forests</a>
  <ul>
  <li><a href="#random-forest-classification-tree" id="toc-random-forest-classification-tree" class="nav-link" data-scroll-target="#random-forest-classification-tree"><span class="header-section-number">6.4.0.1</span> Random Forest Classification Tree</a></li>
  <li><a href="#random-forest-regression-tree" id="toc-random-forest-regression-tree" class="nav-link" data-scroll-target="#random-forest-regression-tree"><span class="header-section-number">6.4.0.2</span> Random Forest Regression Tree</a></li>
  </ul></li>
  <li><a href="#gradient-boosting" id="toc-gradient-boosting" class="nav-link" data-scroll-target="#gradient-boosting"><span class="header-section-number">6.5</span> Gradient Boosting</a>
  <ul>
  <li><a href="#gradient-boosting-classification-tree" id="toc-gradient-boosting-classification-tree" class="nav-link" data-scroll-target="#gradient-boosting-classification-tree"><span class="header-section-number">6.5.0.1</span> Gradient Boosting Classification Tree</a></li>
  <li><a href="#gradient-boosting-regression-tree" id="toc-gradient-boosting-regression-tree" class="nav-link" data-scroll-target="#gradient-boosting-regression-tree"><span class="header-section-number">6.5.0.2</span> Gradient Boosting Regression Tree</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Decision Trees</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Decision trees, also known as classification and regression tree (CART) models, are tree-based methods for supervised machine learning.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Simple classification trees and regression trees are easy to use and interpret, but are not competitive with the best machine learning methods. However, they form the foundation for ensemble models such as bagged trees, random forests, and boosted trees, which although less interpretable, are very accurate.</p>
<p>CART models segment the predictor space into <span class="math inline">\(K\)</span> non-overlapping terminal nodes (leaves). Each node is described by a set of rules which can be used to predict new responses. The predicted value <span class="math inline">\(\hat{y}\)</span> for each node is the mode (classification) or mean (regression).</p>
<p>CART models define the nodes through a <em>top-down greedy</em> process called <em>recursive binary splitting</em>. The process is <em>top-down</em> because it begins at the top of the tree with all observations in a single region and successively splits the predictor space. It is <em>greedy</em> because at each splitting step, the best split is made at that particular step without consideration to subsequent splits.</p>
<p>The best split is the predictor variable and cut point that minimizes a cost function. The most common cost function for regression trees is the sum of squared residuals,</p>
<p><span class="math display">\[RSS = \sum_{k=1}^K\sum_{i \in A_k}{\left(y_i - \hat{y}_{A_k} \right)^2}.\]</span></p>
<p>For classification trees, it is the Gini index,</p>
<p><span class="math display">\[G = \sum_{c=1}^C{\hat{p}_{kc}(1 - \hat{p}_{kc})},\]</span></p>
<p>and the entropy (aka information statistic)</p>
<p><span class="math display">\[D = - \sum_{c=1}^C{\hat{p}_{kc} \log \hat{p}_{kc}}\]</span></p>
<p>where <span class="math inline">\(\hat{p}_{kc}\)</span> is the proportion of training observations in node <span class="math inline">\(k\)</span> that are class <span class="math inline">\(c\)</span>. A completely <em>pure</em> node in a binary tree would have <span class="math inline">\(\hat{p} \in \{ 0, 1 \}\)</span> and <span class="math inline">\(G = D = 0\)</span>. A completely <em>impure</em> node in a binary tree would have <span class="math inline">\(\hat{p} = 0.5\)</span> and <span class="math inline">\(G = 0.5^2 \cdot 2 = 0.25\)</span> and <span class="math inline">\(D = -(0.5 \log(0.5)) \cdot 2 = 0.69\)</span>.</p>
<p>CART repeats the splitting process for each child node until a <em>stopping criterion</em> is satisfied, usually when no node size surpasses a predefined maximum, or continued splitting does not improve the model significantly. CART may also impose a minimum number of observations in each node.</p>
<p>The resulting tree likely over-fits the training data and therefore does not generalize well to test data, so CART <em>prunes</em> the tree, minimizing the cross-validated prediction error. Rather than cross-validating every possible subtree to find the one with minimum error, CART uses <em>cost-complexity pruning</em>. Cost-complexity is the trade off between error (cost) and tree size (complexity) where the trade off is quantified with cost-complexity parameter <span class="math inline">\(c_p\)</span>. The cost complexity of the tree, <span class="math inline">\(R_{c_p}(T)\)</span>, is the sum of its risk (error) plus a “cost complexity” factor <span class="math inline">\(c_p\)</span> multiple of the tree size <span class="math inline">\(|T|\)</span>.</p>
<p><span class="math display">\[R_{c_p}(T) = R(T) + c_p|T|\]</span></p>
<p><span class="math inline">\(c_p\)</span> can take on any value from <span class="math inline">\([0..\infty]\)</span>, but it turns out there is an optimal tree for <em>ranges</em> of <span class="math inline">\(c_p\)</span> values, so there are only a finite set of <em>interesting</em> values for <span class="math inline">\(c_p\)</span> <span class="citation" data-cites="James2013">(<a href="10-references.html#ref-James2013" role="doc-biblioref">James et al. 2013</a>)</span> <span class="citation" data-cites="Therneau2019">(<a href="10-references.html#ref-Therneau2019" role="doc-biblioref">Therneau and Atkinson 2019</a>)</span> <span class="citation" data-cites="Kuhn2016">(<a href="10-references.html#ref-Kuhn2016" role="doc-biblioref">Kuhn and Johnson 2016</a>)</span>. A parametric algorithm identifies the interesting <span class="math inline">\(c_p\)</span> values and their associated pruned trees, <span class="math inline">\(T_{c_p}\)</span>. CART uses cross-validation to determine which <span class="math inline">\(c_p\)</span> is optimal.</p>
<p>The sections in this chapter work through two case studies, using the <code>ISLR::OJ</code> data set to fit classification trees and predict which brand of orange juice, Citrus Hill (CH) or Minute Maid = (MM), customers opurchase from its 17 predictor variables, and using the <code>ISLR::Carseats</code> data set to predict average sales from its 10 feature variables.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)  <span class="co"># better formatted plots than the ones in rpart</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>oj_dat <span class="ot">&lt;-</span> ISLR<span class="sc">::</span>OJ</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(oj_dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,070
Columns: 18
$ Purchase       &lt;fct&gt; CH, CH, CH, MM, CH, CH, CH, CH, CH, CH, CH, CH, CH, CH,…
$ WeekofPurchase &lt;dbl&gt; 237, 239, 245, 227, 228, 230, 232, 234, 235, 238, 240, …
$ StoreID        &lt;dbl&gt; 1, 1, 1, 1, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 1, 2, 2…
$ PriceCH        &lt;dbl&gt; 1.75, 1.75, 1.86, 1.69, 1.69, 1.69, 1.69, 1.75, 1.75, 1…
$ PriceMM        &lt;dbl&gt; 1.99, 1.99, 2.09, 1.69, 1.69, 1.99, 1.99, 1.99, 1.99, 1…
$ DiscCH         &lt;dbl&gt; 0.00, 0.00, 0.17, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0…
$ DiscMM         &lt;dbl&gt; 0.00, 0.30, 0.00, 0.00, 0.00, 0.00, 0.40, 0.40, 0.40, 0…
$ SpecialCH      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ SpecialMM      &lt;dbl&gt; 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0…
$ LoyalCH        &lt;dbl&gt; 0.500000, 0.600000, 0.680000, 0.400000, 0.956535, 0.965…
$ SalePriceMM    &lt;dbl&gt; 1.99, 1.69, 2.09, 1.69, 1.69, 1.99, 1.59, 1.59, 1.59, 1…
$ SalePriceCH    &lt;dbl&gt; 1.75, 1.75, 1.69, 1.69, 1.69, 1.69, 1.69, 1.75, 1.75, 1…
$ PriceDiff      &lt;dbl&gt; 0.24, -0.06, 0.40, 0.00, 0.00, 0.30, -0.10, -0.16, -0.1…
$ Store7         &lt;fct&gt; No, No, No, No, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes,…
$ PctDiscMM      &lt;dbl&gt; 0.000000, 0.150754, 0.000000, 0.000000, 0.000000, 0.000…
$ PctDiscCH      &lt;dbl&gt; 0.000000, 0.000000, 0.091398, 0.000000, 0.000000, 0.000…
$ ListPriceDiff  &lt;dbl&gt; 0.24, 0.24, 0.23, 0.00, 0.00, 0.30, 0.30, 0.24, 0.24, 0…
$ STORE          &lt;dbl&gt; 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2…</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cs_dat <span class="ot">&lt;-</span> ISLR<span class="sc">::</span>Carseats</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(cs_dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 400
Columns: 11
$ Sales       &lt;dbl&gt; 9.50, 11.22, 10.06, 7.40, 4.15, 10.81, 6.63, 11.85, 6.54, …
$ CompPrice   &lt;dbl&gt; 138, 111, 113, 117, 141, 124, 115, 136, 132, 132, 121, 117…
$ Income      &lt;dbl&gt; 73, 48, 35, 100, 64, 113, 105, 81, 110, 113, 78, 94, 35, 2…
$ Advertising &lt;dbl&gt; 11, 16, 10, 4, 3, 13, 0, 15, 0, 0, 9, 4, 2, 11, 11, 5, 0, …
$ Population  &lt;dbl&gt; 276, 260, 269, 466, 340, 501, 45, 425, 108, 131, 150, 503,…
$ Price       &lt;dbl&gt; 120, 83, 80, 97, 128, 72, 108, 120, 124, 124, 100, 94, 136…
$ ShelveLoc   &lt;fct&gt; Bad, Good, Medium, Medium, Bad, Bad, Medium, Good, Medium,…
$ Age         &lt;dbl&gt; 42, 65, 59, 55, 38, 78, 71, 67, 76, 76, 26, 50, 62, 53, 52…
$ Education   &lt;dbl&gt; 17, 10, 12, 14, 13, 16, 15, 10, 10, 17, 10, 13, 18, 18, 18…
$ Urban       &lt;fct&gt; Yes, Yes, Yes, Yes, Yes, No, Yes, Yes, No, No, No, Yes, Ye…
$ US          &lt;fct&gt; Yes, Yes, Yes, Yes, No, Yes, No, Yes, No, Yes, Yes, Yes, N…</code></pre>
</div>
</div>
<p>Partition the data sets into training and testing sets. Use the training set to estimate parameters, compare models and feature engineering techniques, and tune models. Use the testing set as an unbiased source for measuring final model performance. The test set is held in reserve until the end of the project at which point there are only be one or two models under serious consideration.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>(oj_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(oj_dat, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> Purchase))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;Training/Testing/Total&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;855/215/1070&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>oj_train <span class="ot">&lt;-</span> <span class="fu">training</span>(oj_split)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>oj_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(oj_split)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>(cs_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(cs_dat, <span class="at">prop =</span> <span class="fl">0.8</span>))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;Training/Testing/Total&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="do">## &lt;320/80/400&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>cs_train <span class="ot">&lt;-</span> <span class="fu">training</span>(cs_split)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>cs_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(cs_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="classification-tree" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="classification-tree"><span class="header-section-number">6.1</span> Classification Tree</h2>
<p>The simple classification tree is uncommon, but it is the foundation for the more complex ensemble models.</p>
<p>Function <code>rpart::rpart()</code> builds a full tree, minimizing the Gini index <span class="math inline">\(G\)</span> by default (<code>parms = list(split = "gini")</code>), until the stopping criterion is satisfied. The default stopping criterion is</p>
<ul>
<li>only attempt a split if the current node has at least <code>minsplit = 20</code> observations, and</li>
<li>only accept a split if
<ul>
<li>the resulting nodes have at least <code>minbucket = round(minsplit/3)</code> observations, and</li>
<li>the resulting overall fit improves by <code>cp = 0.01</code> (i.e., <span class="math inline">\(\Delta G &lt;= 0.01\)</span>).</li>
</ul></li>
</ul>
<p>Some model parameters like <code>cp</code> (see <code>?rpart.control</code>) are hyperparameters that cannot be optimized directly from the training data set. You can tune hyperparameters by training many models on resampled data sets and exploring how well the models perform.</p>
<p>The <a href="https://www.tidymodels.org/start">tidymodels vignette</a> explains that predictive models should train with resampling methods such as cross-validation to get a short list of candidate models, then choose the best model by comparing performance on the test set. I.e., model selection is a two-phased competition. In this context, we can use CV to fit the best classification tree, then in the next section fit the best bagged tree, then random forest, and so on. The second phase would be to compare all models on the test set.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>oj_cart <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `decision_tree` has 3 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">decision_tree</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cost_complexity =</span> <span class="fu">tune</span>(),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="fu">tune</span>()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(oj_cart<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Purchase <span class="sc">~</span> .)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  oj_cart<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(oj_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">cost_complexity</span>(), <span class="fu">tree_depth</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="fu">factor</span>(tree_depth)) <span class="sc">%&gt;%</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cost_complexity, <span class="at">y =</span> mean, <span class="at">color =</span> tree_depth)) <span class="sc">+</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-cart-class-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of accuracy and ROC was the tree depth of 4 and any cp &lt; .01.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>tune <span class="sc">|&gt;</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 17%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 3%">
<col style="width: 10%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">cost_complexity</th>
<th style="text-align: right;">tree_depth</th>
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">std_err</th>
<th style="text-align: left;">.config</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8023256</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.0138981</td>
<td style="text-align: left;">Preprocessor1_Model06</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8023256</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.0138981</td>
<td style="text-align: left;">Preprocessor1_Model07</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.0000032</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8023256</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.0138981</td>
<td style="text-align: left;">Preprocessor1_Model08</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.0005623</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8023256</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.0138981</td>
<td style="text-align: left;">Preprocessor1_Model09</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.7893981</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.0107471</td>
<td style="text-align: left;">Preprocessor1_Model01</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Select the best model in terms of accuracy and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_cart<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_cart<span class="sc">$</span>workflow, oj_cart<span class="sc">$</span>best_tune)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  oj_cart<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the tree. The output starts with the root node. The predicted class at the root is <code>CH</code> and this prediction produces 333 errors on the 855 observations for a 61% success rate (accuracy) and 39% error rate. The child nodes of node “x” are labeled 2x) and 2x+1), so the child nodes of 1) are 2) and 3), and the child nodes of 2) are 4) and 5), etc. Terminal nodes are labeled with an asterisk (*).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">extract_workflow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Formula
Model: decision_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
Purchase ~ .

── Model ───────────────────────────────────────────────────────────────────────
n= 855 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

 1) root 855 333 CH (0.61052632 0.38947368)  
   2) LoyalCH&gt;=0.48285 534  92 CH (0.82771536 0.17228464)  
     4) LoyalCH&gt;=0.7535455 273  13 CH (0.95238095 0.04761905) *
     5) LoyalCH&lt; 0.7535455 261  79 CH (0.69731801 0.30268199)  
      10) PriceDiff&gt;=-0.165 221  48 CH (0.78280543 0.21719457) *
      11) PriceDiff&lt; -0.165 40   9 MM (0.22500000 0.77500000) *
   3) LoyalCH&lt; 0.48285 321  80 MM (0.24922118 0.75077882)  
     6) LoyalCH&gt;=0.2761415 148  58 MM (0.39189189 0.60810811)  
      12) SalePriceMM&gt;=2.04 71  31 CH (0.56338028 0.43661972) *
      13) SalePriceMM&lt; 2.04 77  18 MM (0.23376623 0.76623377)  
        26) SpecialCH&gt;=0.5 14   6 CH (0.57142857 0.42857143) *
        27) SpecialCH&lt; 0.5 63  10 MM (0.15873016 0.84126984) *
     7) LoyalCH&lt; 0.2761415 173  22 MM (0.12716763 0.87283237) *</code></pre>
</div>
</div>
<p>The first split is at <code>LoyalCH</code> = 0.48285. Here is a diagram of the tree. The node label indicates the predicted value, error rate, and proportion of observations included. Below the nodes are the splitting criteria.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">yesno =</span> <span class="cn">TRUE</span>, <span class="at">roundint =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The boxes show the node classification (based on mode), the proportion of observations that are <em>not</em> <code>CH</code>, and the proportion of observations included in the node.</p>
<p><code>LoyalCH</code> was the most important variable, followed by <code>PriceDiff</code>. A variable’s importance is the sum of the improvement in the overall Gini (or RMSE) measure produced by the nodes in which it appears. From the <strong>rpart</strong> <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf">vignette</a> (page 12),</p>
<blockquote class="blockquote">
<p>“An overall measure of variable importance is the sum of the goodness of split measures for each split for which it was the primary variable, plus goodness (adjusted agreement) for all splits in which it was a surrogate.”</p>
</blockquote>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="measuring-performance" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="measuring-performance">Measuring Performance</h3>
<p><code>collect_metrics()</code> shows the accuracy and ROC AUC metrics.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric     .estimator .estimate .config             
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary         0.856 Preprocessor1_Model1
2 roc_auc     binary         0.909 Preprocessor1_Model1
3 brier_class binary         0.110 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve.</p>
<section id="confusion-matrix" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="confusion-matrix">Confusion Matrix</h4>
<p>The confusion matrix calculates the model performance predicting on the holdout testing data set.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>confmat <span class="ot">&lt;-</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> Purchase, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># oj_cart$preds &lt;- </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   bind_cols(</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#      predict(oj_cart$fit, new_data = oj_test, type = "prob"),</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">#      predicted = predict(oj_cart$fit, new_data = oj_test, type = "class"),</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">#      actual = oj_test$Purchase</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>confmat</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="do">##           Truth</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Prediction  CH  MM</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="do">##         CH 120  20</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="do">##         MM  11  64</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(oj_cart<span class="sc">$</span>confmat)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 13 × 3</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="do">##    .metric              .estimator .estimate</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="do">##  1 accuracy             binary         0.856</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="do">##  2 kap                  binary         0.691</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="do">##  3 sens                 binary         0.916</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="do">##  4 spec                 binary         0.762</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="do">##  5 ppv                  binary         0.857</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="do">##  6 npv                  binary         0.853</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="do">##  7 mcc                  binary         0.694</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="do">##  8 j_index              binary         0.678</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="do">##  9 bal_accuracy         binary         0.839</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 detection_prevalence binary         0.651</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 11 precision            binary         0.857</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 recall               binary         0.916</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 13 f_meas               binary         0.886</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>You can bound the accuracy with a 95% CI using the binomial test.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">binom.test</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table <span class="sc">%&gt;%</span> <span class="fu">diag</span>() <span class="sc">%&gt;%</span> <span class="fu">sum</span>(), </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table <span class="sc">%&gt;%</span> <span class="fu">sum</span>()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Exact binomial test

data:  oj_cart$confmat$table %&gt;% diag() %&gt;% sum() and oj_cart$confmat$table %&gt;% sum()
number of successes = 184, number of trials = 215, p-value &lt; 2.2e-16
alternative hypothesis: true probability of success is not equal to 0.5
95 percent confidence interval:
 0.8016244 0.8998833
sample estimates:
probability of success 
              0.855814 </code></pre>
</div>
</div>
<p>The detection prevalence (aka, no information rate (NIR)) statistic is the class rate for the largest class. In this case CH is the largest class, so NIR = 133/213 = 0.6186. The binomial test for NIR is the probability of that the model accuracy is significantly better than the NIR (i.e., significantly better than just always guessing CH).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">binom.test</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table[<span class="st">"CH"</span>, ] <span class="sc">%&gt;%</span> <span class="fu">sum</span>(), </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table <span class="sc">%&gt;%</span> <span class="fu">sum</span>(),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table[, <span class="st">"CH"</span>]) <span class="sc">/</span> <span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">alternative =</span> <span class="st">"greater"</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Exact binomial test

data:  oj_cart$confmat$table["CH", ] %&gt;% sum() and oj_cart$confmat$table %&gt;% sum()
number of successes = 140, number of trials = 215, p-value = 0.1169
alternative hypothesis: true probability of success is greater than 0.6093023
95 percent confidence interval:
 0.5940371 1.0000000
sample estimates:
probability of success 
             0.6511628 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">binom.test</span>(<span class="at">x =</span> <span class="dv">116</span> <span class="sc">+</span> <span class="dv">67</span>, <span class="at">n =</span> <span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table), </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">p =</span> (<span class="dv">116</span><span class="sc">+</span><span class="dv">17</span>)<span class="sc">/</span><span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table), </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">alternative =</span> <span class="st">"greater"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    Exact binomial test

data:  116 + 67 and sum(oj_cart$confmat$table)
number of successes = 183, number of trials = 215, p-value = 5.461e-14
alternative hypothesis: true probability of success is greater than 0.6186047
95 percent confidence interval:
 0.8052886 1.0000000
sample estimates:
probability of success 
             0.8511628 </code></pre>
</div>
</div>
<p>The accuracy statistic indicates the model predicts 85.6% of the observations correctly. That’s good, but less impressive when you consider the prevalence of CH is 65.1% - you could achieve that accuracy just by predicting CH every time. A measure that controls for the prevalence is Cohen’s kappa statistic. The kappa statistic is explained <a href="https://standardwisdom.com/softwarejournal/2011/12/confusion-matrix-another-single-value-metric-kappa-statistic/">here</a>. It compares the accuracy to the accuracy of a “random system”. It is defined as</p>
<p><span class="math display">\[\kappa = \frac{\text{Accuracy} - RA}{1-RA}\]</span></p>
<p>where</p>
<p><span class="math display">\[RA = \frac{\text{ActFalse} \times \text{PredFalse} + \text{ActTrue} \times \text{PredTrue}}{\text{Total} \times \text{Total}}\]</span></p>
<p>is the hypothetical probability of a chance agreement.</p>
<p>The kappa statistic varies from 0 to 1 where 0 means accurate predictions occur merely by chance, and 1 means the predictions are in perfect agreement with the observations. In this case, a kappa statistic of 0.7064 is “substantial”. See chart <a href="https://www.statisticshowto.datasciencecentral.com/cohens-kappa-statistic/">here</a>.</p>
<p>You can remind yourself what the other confusion matrix measures are from the documentation. Visuals are almost always helpful. Here is a plot of the confusion matrix.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Purchase, .pred_class) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Simple Classification: Predicted vs. Actual"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Actual"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Predicted"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="roc-curve" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="roc-curve">ROC Curve</h4>
<p>The ROC (receiver operating characteristics) curve <span class="citation" data-cites="Fawcett2005">(<a href="10-references.html#ref-Fawcett2005" role="doc-biblioref">Fawcett 2005</a>)</span> is another measure of accuracy. The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. By default, the threshold for predicting the default classification is 0.50, but it could be any threshold. <code>precrec::evalmod()</code> calculates the confusion matrix values from the model using the holdout data set. The AUC on the holdout set is 0.909. <code>pRoc::plot.roc()</code>, <code>plotROC::geom_roc()</code>, and <code>yardstick::roc_curve()</code> are options for plotting a ROC curve.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ CART ROC Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A few points on the ROC space are helpful for understanding how to use it.</p>
<ul>
<li>The lower left point (0, 0) is the result of <em>always</em> predicting “negative” or in this case “MM” if “CH” is taken as the default class. No false positives, but no true positives either.</li>
<li>The upper right point (1, 1) is the result of <em>always</em> predicting “positive” (“CH” here). You catch all true positives, but miss all the true negatives.</li>
<li>The upper left point (0, 1) is the result of perfect accuracy.</li>
<li>The lower right point (1, 0) is the result of perfect imbecility. You made the exact wrong prediction every time.</li>
<li>The 45 degree diagonal is the result of randomly guessing positive (CH) X percent of the time. If you guess positive 90% of the time and the prevalence is 50%, your TPR will be 90% and your FPR will also be 90%, etc.</li>
</ul>
<p>The goal is for all nodes to bunch up in the upper left.</p>
<p>Points to the left of the diagonal with a low TPR can be thought of as “conservative” predictors - they only make positive (CH) predictions with strong evidence. Points to the left of the diagonal with a high TPR can be thought of as “liberal” predictors - they make positive (CH) predictions with weak evidence.</p>
</section>
<section id="gain-curve" class="level4" data-number="6.1.0.1">
<h4 data-number="6.1.0.1" class="anchored" data-anchor-id="gain-curve"><span class="header-section-number">6.1.0.1</span> Gain Curve</h4>
<p>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value. The “wizard” curve is the gain curve when the data is sorted by the true outcome. If the model’s gain curve is close to the wizard curve, then the model predicted the response variable well. The gray area is the “gain” over a random prediction.</p>
<p>131 of the 215 consumers in the holdout testing set purchased CH.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
     .n .n_events .percent_tested .percent_found
  &lt;dbl&gt;     &lt;dbl&gt;           &lt;dbl&gt;          &lt;dbl&gt;
1     0         0             0              0  
2    82        79            38.1           60.3
3   129       114            60             87.0
4   131       116            60.9           88.5
5   140       120            65.1           91.6
6   146       123            67.9           93.9
7   165       126            76.7           96.2
8   215       131           100            100  </code></pre>
</div>
</div>
<ul>
<li><p>The gain curve encountered 79 CH purchasers (60.3%) within the first 82 observations (38.1%).</p></li>
<li><p>It encountered all 131 CH purchasers on the 215th observation (100%).</p></li>
<li><p>The bottom of the gray area is the outcome of a random model. Only half the CH purchasers would be observed within 50% of the observations. The top of the gray area is the outcome of the perfect model, the “wizard curve”. Half the CH purchasers would be observed in ~30% of the observations.</p></li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ CART Gain Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="regression-tree" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="regression-tree"><span class="header-section-number">6.2</span> Regression Tree</h2>
<p>A simple regression tree is built in a manner similar to a simple classification tree, and like the simple classification tree, it is rarely invoked on its own; the bagged, random forest, and gradient boosting methods build on this logic.</p>
<p>The first step is to build a full tree, then perform k-fold cross-validation to help select the optimal cost complexity (cp). The only difference here is the <code>set_Mode("regression")</code> call to produce a regression tree.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>cs_cart <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `decision_tree` has 3 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">decision_tree</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cost_complexity =</span> <span class="fu">tune</span>(),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="fu">tune</span>()</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(cs_cart<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sales <span class="sc">~</span> .)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  cs_cart<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(cs_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">cost_complexity</span>(), <span class="fu">tree_depth</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: rmse and rsq.</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="fu">factor</span>(tree_depth)) <span class="sc">%&gt;%</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cost_complexity, <span class="at">y =</span> mean, <span class="at">color =</span> tree_depth)) <span class="sc">+</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-cart-reg-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of RMSE was the tree depth of 8 and any cp &lt; 5.6E-04.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  cost_complexity tree_depth .metric .estimator  mean     n std_err .config     
            &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;       
1    0.0000000001          8 rmse    standard    2.02    10  0.0731 Preprocesso…
2    0.0000000178          8 rmse    standard    2.02    10  0.0731 Preprocesso…
3    0.00000316            8 rmse    standard    2.02    10  0.0731 Preprocesso…
4    0.000562              8 rmse    standard    2.02    10  0.0731 Preprocesso…
5    0.0000000001         11 rmse    standard    2.02    10  0.0731 Preprocesso…</code></pre>
</div>
</div>
<p>Select the best model in terms of rmse and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_cart<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_cart<span class="sc">$</span>workflow, cs_cart<span class="sc">$</span>best_tune)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  cs_cart<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the tree. The output starts with the root node. The predicted sales at the root is the mean sales in the testing data set is 7.65 (values are $000s). The deviance at the root is the SSE, 2,551. The first split is at <code>ShelveLoc</code> = [Bad, Medium] vs Good.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">extract_workflow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Formula
Model: decision_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
Sales ~ .

── Model ───────────────────────────────────────────────────────────────────────
n= 320 

node), split, n, deviance, yval
      * denotes terminal node

  1) root 320 2551.272000  7.654125  
    2) ShelveLoc=Bad,Medium 245 1430.391000  6.880531  
      4) Price&gt;=94.5 204 1040.546000  6.447353  
        8) Advertising&lt; 7.5 119  495.019700  5.743025  
         16) ShelveLoc=Bad 35  107.500700  4.609714  
           32) Population&lt; 196.5 16   48.386700  3.837500 *
           33) Population&gt;=196.5 19   41.538400  5.260000 *
         17) ShelveLoc=Medium 84  323.834500  6.215238  
           34) Price&gt;=127 28  119.289000  4.952857  
             68) Age&gt;=67 7   22.955970  2.734286 *
             69) Age&lt; 67 21   50.393780  5.692381  
              138) CompPrice&lt; 135 11   10.383490  4.590909 *
              139) CompPrice&gt;=135 10   11.984440  6.904000 *
           35) Price&lt; 127 56  137.614100  6.846429  
             70) CompPrice&lt; 124.5 31   36.984390  6.012581  
              140) Price&gt;=108.5 12   10.703470  5.443333 *
              141) Price&lt; 108.5 19   19.936520  6.372105 *
             71) CompPrice&gt;=124.5 25   52.347900  7.880400  
              142) Age&gt;=74.5 8   11.584690  6.398750 *
              143) Age&lt; 74.5 17   14.936310  8.577647 *
        9) Advertising&gt;=7.5 85  403.846300  7.433412  
         18) Age&gt;=58 34  150.180000  6.219412  
           36) Price&gt;=135.5 7    7.098371  4.184286 *
           37) Price&lt; 135.5 27  106.573000  6.747037  
             74) CompPrice&lt; 123.5 15   34.053370  5.501333 *
             75) CompPrice&gt;=123.5 12   20.147090  8.304167 *
         19) Age&lt; 58 51  170.151200  8.242745  
           38) Price&gt;=127 22   49.335900  6.969545  
             76) Advertising&lt; 14 13   19.492320  6.385385 *
             77) Advertising&gt;=14 9   18.999600  7.813333 *
           39) Price&lt; 127 29   58.097940  9.208621  
             78) CompPrice&lt; 130.5 16   27.176440  8.598125 *
             79) CompPrice&gt;=130.5 13   17.618800  9.960000 *
      5) Price&lt; 94.5 41  161.103600  9.035854  
       10) Income&lt; 57 9   29.422620  7.285556 *
       11) Income&gt;=57 32   96.354490  9.528125  
         22) CompPrice&lt; 123.5 24   54.578700  8.990417  
           44) Price&gt;=74.5 17   26.677550  8.412941 *
           45) Price&lt; 74.5 7    8.464143 10.392860 *
         23) CompPrice&gt;=123.5 8   14.019290 11.141250 *
    3) ShelveLoc=Good 75  495.303800 10.181200  
      6) Price&gt;=107.5 51  267.569700  9.221765  
       12) Advertising&lt; 13.5 44  176.815800  8.706818  
         24) Price&gt;=142.5 11   36.270690  7.099091 *
         25) Price&lt; 142.5 33  102.634900  9.242727  

...
and 8 more lines.</code></pre>
</div>
</div>
<p>Here is a diagram of the tree. The node label indicates the predicted value (mean) and the proportion of observations that are in the node (or child nodes). Below the nodes are the splitting criteria.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">yesno =</span> <span class="cn">TRUE</span>, <span class="at">roundint =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>Price</code> and <code>ShelveLoc</code> were the most important variables.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="measuring-performance-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="measuring-performance-1">Measuring Performance</h3>
<p><code>collect_metrics()</code> returns the RMSE, <span class="math inline">\(RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})\)</span> and the model <span class="math inline">\(R^2\)</span>. The RMSE of 2.11 in the test data set is pretty good considering the standard deviation of <code>Sales</code> is 2.74.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric .estimator .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard       2.11  Preprocessor1_Model1
2 rsq     standard       0.464 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>Here is a predicted vs actual plot.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats CART, Predicted vs Actual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The tree nodes do a decent job of binning the observations. The predictions vs actuals plot suggests the model over-estimates at the low end and underestimates at the high end. Calculate the test data set RMSE.</p>
</section>
</section>
<section id="bagged-trees" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="bagged-trees"><span class="header-section-number">6.3</span> Bagged Trees</h2>
<p>One drawback of decision trees is that they are high-variance estimators. A small number of additional training observations can dramatically alter the prediction performance of a learned tree.</p>
<p>Bootstrap aggregation, or <em>bagging</em>, is a general-purpose procedure for reducing the variance of a statistical learning method. The algorithm constructs <em>B</em> regression trees using <em>B</em> bootstrapped training sets, and averages the resulting predictions. These trees are grown deep, and are not pruned. Hence each individual tree has high variance, but low bias. Averaging the <em>B</em> trees reduces the variance. The predicted value for an observation is the mode (classification) or mean (regression) of the trees. <em>B</em> usually equals ~25.</p>
<p>To test the model accuracy, the out-of-bag observations are predicted from the models. For a training set of size <em>n</em>, each tree is composed of <span class="math inline">\(\sim (1 - e^{-1})n = .632n\)</span> unique observations in-bag and <span class="math inline">\(.368n\)</span> out-of-bag. For each tree in the ensemble, bagging makes predictions on the tree’s out-of-bag observations. I think (<em>see</em> page 197 of <span class="citation" data-cites="Kuhn2016">(<a href="10-references.html#ref-Kuhn2016" role="doc-biblioref">Kuhn and Johnson 2016</a>)</span>) bagging measures the performance (RMSE, Accuracy, ROC, etc.) of each tree in the ensemble and averages them to produce an overall performance estimate. (This makes no sense to me. If each tree has poor performance, then the average performance of many trees will still be poor. An ensemble of <em>B</em> trees will produce <span class="math inline">\(\sim .368 B\)</span> predictions per unique observation. Seems like you should take the mean/mode of each observation’s prediction as the final prediction. Then you have <em>n</em> predictions to compare to <em>n</em> actuals, and you assess performance on that.)</p>
<p>The downside to bagging is that there is no single tree with a set of rules to interpret. It becomes unclear which variables are more important than others.</p>
<p>The next section explains how bagged trees are a special case of random forests.</p>
<section id="bagged-classification-tree" class="level3" data-number="6.3.1">
<h3 data-number="6.3.1" class="anchored" data-anchor-id="bagged-classification-tree"><span class="header-section-number">6.3.1</span> Bagged Classification Tree</h3>
<p>Leaning by example, I’ll predict <code>Purchase</code> from the <code>OJ</code> data set again, this time using the bagging with <code>parsnip::bag_tree()</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>oj_bag <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `bag_tree` has 4 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bag_tree</span>(</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cost_complexity =</span> <span class="fu">tune</span>(),</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="fu">tune</span>()</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(oj_bag<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Purchase <span class="sc">~</span> .)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  oj_bag<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(oj_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">cost_complexity</span>(), <span class="fu">tree_depth</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="fu">factor</span>(tree_depth)) <span class="sc">%&gt;%</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cost_complexity, <span class="at">y =</span> mean, <span class="at">color =</span> tree_depth)) <span class="sc">+</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-bag-class-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of accuracy and ROC was the tree depth of 4 and any cp &lt;= 3.16e-06.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  cost_complexity tree_depth .metric  .estimator  mean     n std_err .config    
            &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;      
1    0.000562              4 accuracy binary     0.825    10  0.0107 Preprocess…
2    0.0000000001          4 accuracy binary     0.823    10  0.0109 Preprocess…
3    0.0000000178          4 accuracy binary     0.822    10  0.0108 Preprocess…
4    0.00000316            4 accuracy binary     0.821    10  0.0126 Preprocess…
5    0.000562              8 accuracy binary     0.813    10  0.0156 Preprocess…</code></pre>
</div>
</div>
<p>Select the best model in terms of accuracy and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_bag<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_bag<span class="sc">$</span>workflow, oj_bag<span class="sc">$</span>best_tune)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  oj_bag<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I <em>think</em> tidymodels started by splitting the training set into 10 folds, then using 9 of the folds to run the bagging algorithm and collect performance measures on the hold-out fold. After repeating the process for all 10 folds, it averaged the performance measures to produce the resampling results shown below. With hyperparameters, the process is repeated for all combinations and the resampling results above are from the best performing combination.</p>
<p>There is no single tree to visualize, and you can’t even produce a VIP. Let’s look at the performance on the holdout data set. <code>collect_metrics()</code> shows the accuracy and ROC AUC metrics. The accuracy is slightly lower than the single tree, but ROC AUC is higher.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric     .estimator .estimate .config             
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary         0.842 Preprocessor1_Model1
2 roc_auc     binary         0.925 Preprocessor1_Model1
3 brier_class binary         0.105 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve. The confusion matrix calculates the model performance predicting on the holdout testing data set.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>confmat <span class="ot">&lt;-</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> Purchase, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>confmat</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="do">##           Truth</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Prediction  CH  MM</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="do">##         CH 115  18</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="do">##         MM  16  66</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(oj_bag<span class="sc">$</span>confmat)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 13 × 3</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="do">##    .metric              .estimator .estimate</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  1 accuracy             binary         0.842</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  2 kap                  binary         0.666</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  3 sens                 binary         0.878</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="do">##  4 spec                 binary         0.786</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="do">##  5 ppv                  binary         0.865</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a><span class="do">##  6 npv                  binary         0.805</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="do">##  7 mcc                  binary         0.667</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="do">##  8 j_index              binary         0.664</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="do">##  9 bal_accuracy         binary         0.832</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 detection_prevalence binary         0.619</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 11 precision            binary         0.865</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 recall               binary         0.878</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 13 f_meas               binary         0.871</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Purchase, .pred_class) <span class="sc">%&gt;%</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Bagged Trees: Predicted vs. Actual"</span>,</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Actual"</span>,</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Predicted"</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. The AUC on the holdout set is 0.925.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Bagged Trees ROC Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Bagged Trees Gain Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bagging-regression-tree" class="level3" data-number="6.3.2">
<h3 data-number="6.3.2" class="anchored" data-anchor-id="bagging-regression-tree"><span class="header-section-number">6.3.2</span> Bagging Regression Tree</h3>
<p>I’ll predict <code>Sales</code> from the <code>Carseats</code> data set again, this time with <code>parsnip::bag_tree()</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(baguette)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>cs_bag <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># `bag_tree` has 4 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bag_tree</span>(</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">cost_complexity =</span> <span class="fu">tune</span>(),</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="fu">tune</span>()</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(cs_bag<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sales <span class="sc">~</span> .)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>  cs_bag<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(cs_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">cost_complexity</span>(), <span class="fu">tree_depth</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="fu">factor</span>(tree_depth)) <span class="sc">%&gt;%</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cost_complexity, <span class="at">y =</span> mean, <span class="at">color =</span> tree_depth)) <span class="sc">+</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-bag-reg-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of RMSE was the tree depth of 8 and any cp &lt; 5.6E-04.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  cost_complexity tree_depth .metric .estimator  mean     n std_err .config     
            &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;       
1    0.000562             11 rmse    standard    1.58    10  0.0416 Preprocesso…
2    0.0000000178         15 rmse    standard    1.58    10  0.0585 Preprocesso…
3    0.000562             15 rmse    standard    1.59    10  0.0639 Preprocesso…
4    0.0000000001         11 rmse    standard    1.60    10  0.0652 Preprocesso…
5    0.00000316            8 rmse    standard    1.63    10  0.0618 Preprocesso…</code></pre>
</div>
</div>
<p>Select the best model in terms of rmse and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_bag<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_bag<span class="sc">$</span>workflow, cs_bag<span class="sc">$</span>best_tune)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  cs_bag<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>collect_metrics()</code> returns the RMSE, <span class="math inline">\(RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})\)</span> and the model <span class="math inline">\(R^2\)</span>. The RMSE of <code>cs_bag$fit %&gt;% collect_metrics() %&gt;% filter(.metric == "rmse") %&gt;% pull(.estimate) %&gt;% comma(.01)</code> in the test data set is pretty good considering the standard deviation of <code>Sales</code> is <code>comma(sd(cs_test$Sales), .01)</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric .estimator .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard       1.68  Preprocessor1_Model1
2 rsq     standard       0.643 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>Here is a predicted vs actual plot.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats Bagged Trees, Predicted vs Actual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="random-forests" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="random-forests"><span class="header-section-number">6.4</span> Random Forests</h2>
<p>Random forests improve bagged trees by way of a small tweak that de-correlates the trees. As in bagging, the algorithm builds a number of decision trees on bootstrapped training samples. But when building these decision trees, each time a split in a tree is considered, a random sample of <em>mtry</em> predictors is chosen as split candidates from the full set of <em>p</em> predictors. A fresh sample of <em>mtry</em> predictors is taken at each split. Typically <span class="math inline">\(mtry \sim \sqrt{p}\)</span>. Bagged trees are thus a special case of random forests where <em>mtry = p</em>.</p>
<section id="random-forest-classification-tree" class="level4" data-number="6.4.0.1">
<h4 data-number="6.4.0.1" class="anchored" data-anchor-id="random-forest-classification-tree"><span class="header-section-number">6.4.0.1</span> Random Forest Classification Tree</h4>
<p>Leaning by example, I’ll predict <code>Purchase</code> from the <code>OJ</code> data set again, this time using the bagging with <code>parsnip::rand_forest()</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>oj_rf <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `rand_forest` has 3 hyperparameters (`mtry`, `trees`, and</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># optimize just `trees` and `min_n`.</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_n =</span> <span class="fu">tune</span>()</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(oj_rf<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Purchase <span class="sc">~</span> .)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  oj_rf<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(oj_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">trees</span>(), <span class="fu">min_n</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trees =</span> <span class="fu">factor</span>(trees)) <span class="sc">%&gt;%</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> min_n, <span class="at">y =</span> mean, <span class="at">color =</span> trees)) <span class="sc">+</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-rf-class-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of accuracy and ROC was the trees of 1000 and any minimum node size of 40.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  trees min_n .metric  .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1  1500    30 accuracy binary     0.813    10  0.0122 Preprocessor1_Model19
2  1000    40 accuracy binary     0.812    10  0.0111 Preprocessor1_Model23
3   500    40 accuracy binary     0.812    10  0.0125 Preprocessor1_Model22
4  1000    30 accuracy binary     0.812    10  0.0130 Preprocessor1_Model18
5   500    30 accuracy binary     0.812    10  0.0127 Preprocessor1_Model17</code></pre>
</div>
</div>
<p>Select the best model in terms of accuracy and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_rf<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_rf<span class="sc">$</span>workflow, oj_rf<span class="sc">$</span>best_tune)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  oj_rf<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>There is no single tree to visualize, and you can’t even produce a VIP. Let’s look at the performance on the holdout data set. <code>collect_metrics()</code> shows the accuracy and ROC AUC metrics. The accuracy is slightly lower than the single tree, but ROC AUC is higher than both the single tree and bagged trees.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric     .estimator .estimate .config             
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary         0.847 Preprocessor1_Model1
2 roc_auc     binary         0.935 Preprocessor1_Model1
3 brier_class binary         0.107 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve. The confusion matrix calculates the model performance predicting on the holdout testing data set.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>confmat <span class="ot">&lt;-</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> Purchase, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>confmat</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="do">##           Truth</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Prediction  CH  MM</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="do">##         CH 116  18</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="do">##         MM  15  66</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(oj_rf<span class="sc">$</span>confmat)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 13 × 3</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="do">##    .metric              .estimator .estimate</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  1 accuracy             binary         0.847</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  2 kap                  binary         0.676</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  3 sens                 binary         0.885</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a><span class="do">##  4 spec                 binary         0.786</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="do">##  5 ppv                  binary         0.866</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="do">##  6 npv                  binary         0.815</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="do">##  7 mcc                  binary         0.676</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a><span class="do">##  8 j_index              binary         0.671</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a><span class="do">##  9 bal_accuracy         binary         0.836</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 detection_prevalence binary         0.623</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 11 precision            binary         0.866</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 recall               binary         0.885</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 13 f_meas               binary         0.875</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Purchase, .pred_class) <span class="sc">%&gt;%</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Random Forest: Predicted vs. Actual"</span>,</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Actual"</span>,</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Predicted"</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. The AUC on the holdout set is 0.935.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Random Forest ROC Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Random Forest Gain Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="random-forest-regression-tree" class="level4" data-number="6.4.0.2">
<h4 data-number="6.4.0.2" class="anchored" data-anchor-id="random-forest-regression-tree"><span class="header-section-number">6.4.0.2</span> Random Forest Regression Tree</h4>
<p>I’ll predict <code>Sales</code> from the <code>Carseats</code> data set again, this time with <code>parsnip::rand_forest()</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>cs_rf <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `rand_forest` has 3 hyperparameters (`mtry`, `trees`, and</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># optimize just `trees` and `min_n`.</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_n =</span> <span class="fu">tune</span>()</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(cs_rf<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sales <span class="sc">~</span> .)</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>  cs_rf<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(cs_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">trees</span>(), <span class="fu">min_n</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trees =</span> <span class="fu">factor</span>(trees)) <span class="sc">%&gt;%</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> min_n, <span class="at">y =</span> mean, <span class="at">color =</span> trees)) <span class="sc">+</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-rf-reg-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of RMSE was 2000 tree with at least 2 data points per node.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  trees min_n .metric .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1  1000     2 rmse    standard    1.72    10  0.0707 Preprocessor1_Model03
2   500     2 rmse    standard    1.73    10  0.0724 Preprocessor1_Model02
3  1500     2 rmse    standard    1.73    10  0.0696 Preprocessor1_Model04
4  2000     2 rmse    standard    1.73    10  0.0687 Preprocessor1_Model05
5  1500    11 rmse    standard    1.77    10  0.0681 Preprocessor1_Model09</code></pre>
</div>
</div>
<p>Select the best model in terms of rmse and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_rf<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_rf<span class="sc">$</span>workflow, cs_rf<span class="sc">$</span>best_tune)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  cs_rf<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>collect_metrics()</code> returns the RMSE, <span class="math inline">\(RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})\)</span> and the model <span class="math inline">\(R^2\)</span>. The RMSE of 1.78 in the test data set is pretty good considering the standard deviation of <code>Sales</code> is 2.74.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric .estimator .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard       1.78  Preprocessor1_Model1
2 rsq     standard       0.665 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>Here is a predicted vs actual plot.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats Random Forest, Predicted vs Actual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="gradient-boosting" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="gradient-boosting"><span class="header-section-number">6.5</span> Gradient Boosting</h2>
<p><strong>Note</strong>: I learned gradient boosting from <a href="https://explained.ai/gradient-boosting/L2-loss.html">explained.ai</a>.</p>
<p>Gradient boosting machine (GBM) is an additive modeling algorithm that gradually builds a composite model by iteratively adding <em>M</em> weak sub-models based on the performance of the prior iteration’s composite,</p>
<p><span class="math display">\[F_M(x) = \sum_m^M f_m(x).\]</span></p>
<p>The idea is to fit a weak model, then replace the response values with the residuals from that model, and fit another model. Adding the residual prediction model to the original response prediction model produces a more accurate model. GBM repeats this process over and over, running new models to predict the residuals of the previous composite models, and adding the results to produce new composites. With each iteration, the model becomes stronger and stronger. The successive trees are usually weighted to slow down the learning rate. “Shrinkage” reduces the influence of each individual tree and leaves space for future trees to improve the model.</p>
<p><span class="math display">\[F_M(x) = f_0 + \eta\sum_{m = 1}^M f_m(x).\]</span></p>
<p>The smaller the learning rate, <span class="math inline">\(\eta\)</span>, the larger the number of trees, <span class="math inline">\(M\)</span>. <span class="math inline">\(\eta\)</span> and <span class="math inline">\(M\)</span> are hyperparameters. Other constraints to the trees are usually applied as additional hyperparameters, including, tree depth, number of nodes, minimum observations per split, and minimum improvement to loss.</p>
<p>The name “gradient boosting” refers to the <em>boosting</em> of a model with a <em>gradient</em>. Each round of training builds a <em>weak learner</em> and uses the residuals to calculate a gradient, the partial derivative of the loss function. Gradient boosting “descends the gradient” to adjust the model parameters to reduce the error in the next round of training.</p>
<p>In the case of classification problems, the loss function is the log-loss; for regression problems, the loss function is mean squared error. GBM continues until it reaches maximum number of trees or an acceptable error level.</p>
<section id="gradient-boosting-classification-tree" class="level4" data-number="6.5.0.1">
<h4 data-number="6.5.0.1" class="anchored" data-anchor-id="gradient-boosting-classification-tree"><span class="header-section-number">6.5.0.1</span> Gradient Boosting Classification Tree</h4>
<p>Leaning by example, I’ll predict <code>Purchase</code> from the <code>OJ</code> data set again, this time using the bagging with <code>parsnip::boost_tree()</code></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>oj_xgb <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `boost_tree` has 8 hyperparameters. Let's optimize just `trees` and `min_n`.</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>(</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_n =</span> <span class="fu">tune</span>()</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(oj_xgb<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Purchase <span class="sc">~</span> .)</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>  oj_xgb<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(oj_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">trees</span>(), <span class="fu">min_n</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trees =</span> <span class="fu">factor</span>(trees)) <span class="sc">%&gt;%</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> min_n, <span class="at">y =</span> mean, <span class="at">color =</span> trees)) <span class="sc">+</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-xgboost-class-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of accuracy and ROC was the trees of 1000 and any minimum node size of 40.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  trees min_n .metric  .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1   500    30 accuracy binary     0.814    10 0.0146  Preprocessor1_Model17
2  1500    30 accuracy binary     0.814    10 0.0121  Preprocessor1_Model19
3  2000    30 accuracy binary     0.814    10 0.0121  Preprocessor1_Model20
4     1     2 accuracy binary     0.814    10 0.00999 Preprocessor1_Model01
5  1000    30 accuracy binary     0.811    10 0.0149  Preprocessor1_Model18</code></pre>
</div>
</div>
<p>Select the best model in terms of accuracy and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_xgb<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_xgb<span class="sc">$</span>workflow, oj_xgb<span class="sc">$</span>best_tune)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  oj_xgb<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>There is no single tree to visualize, and you can’t even produce a VIP. Let’s look at the performance on the holdout data set. <code>collect_metrics()</code> shows the accuracy and ROC AUC metrics.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric     .estimator .estimate .config             
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary         0.842 Preprocessor1_Model1
2 roc_auc     binary         0.932 Preprocessor1_Model1
3 brier_class binary         0.103 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve. The confusion matrix calculates the model performance predicting on the holdout testing data set.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>confmat <span class="ot">&lt;-</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> Purchase, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>confmat</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="do">##           Truth</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Prediction  CH  MM</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="do">##         CH 114  17</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="do">##         MM  17  67</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(oj_xgb<span class="sc">$</span>confmat)</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 13 × 3</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="do">##    .metric              .estimator .estimate</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  1 accuracy             binary         0.842</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  2 kap                  binary         0.668</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  3 sens                 binary         0.870</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="do">##  4 spec                 binary         0.798</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="do">##  5 ppv                  binary         0.870</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="do">##  6 npv                  binary         0.798</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="do">##  7 mcc                  binary         0.668</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="do">##  8 j_index              binary         0.668</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="do">##  9 bal_accuracy         binary         0.834</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 detection_prevalence binary         0.609</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 11 precision            binary         0.870</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 12 recall               binary         0.870</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 13 f_meas               binary         0.870</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Purchase, .pred_class) <span class="sc">%&gt;%</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"XGBoost: Predicted vs. Actual"</span>,</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Actual"</span>,</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Predicted"</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. The AUC on the holdout set is 0.932.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ XGBoost ROC Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ XGBoost Gain Curve"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="gradient-boosting-regression-tree" class="level4" data-number="6.5.0.2">
<h4 data-number="6.5.0.2" class="anchored" data-anchor-id="gradient-boosting-regression-tree"><span class="header-section-number">6.5.0.2</span> Gradient Boosting Regression Tree</h4>
<p>I’ll predict <code>Sales</code> from the <code>Carseats</code> data set again, this time with <code>parsnip::rand_forest()</code>.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>cs_xgb <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `rand_forest` has 3 hyperparameters (`mtry`, `trees`, and</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co"># optimize just `trees` and `min_n`.</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>model <span class="ot">&lt;-</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>(</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_n =</span> <span class="fu">tune</span>()</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune a model using the workflow framework.</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>workflow <span class="ot">&lt;-</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(cs_xgb<span class="sc">$</span>model) <span class="sc">%&gt;%</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sales <span class="sc">~</span> .)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="co"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a><span class="co"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>tune_grid <span class="ot">&lt;-</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>  cs_xgb<span class="sc">$</span>workflow <span class="sc">%&gt;%</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(cs_train, <span class="at">v =</span> <span class="dv">10</span>), </span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="fu">grid_regular</span>(<span class="fu">trees</span>(), <span class="fu">min_n</span>(), <span class="at">levels =</span> <span class="dv">5</span>)</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a><span class="co"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>tune_grid <span class="sc">%&gt;%</span> </span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trees =</span> <span class="fu">factor</span>(trees)) <span class="sc">%&gt;%</span></span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> min_n, <span class="at">y =</span> mean, <span class="at">color =</span> trees)) <span class="sc">+</span></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(.metric), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/fit-xgboost-reg-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The best models in terms of RMSE was 500 trees with at least 21 data points per node.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  trees min_n .metric .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1   500    11 rmse    standard    1.36    10  0.0674 Preprocessor1_Model07
2  1000    11 rmse    standard    1.36    10  0.0674 Preprocessor1_Model08
3  1500    11 rmse    standard    1.36    10  0.0674 Preprocessor1_Model09
4  2000    11 rmse    standard    1.36    10  0.0674 Preprocessor1_Model10
5   500    40 rmse    standard    1.38    10  0.0759 Preprocessor1_Model22</code></pre>
</div>
</div>
<p>Select the best model in terms of rmse and finalize the model.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_xgb<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_xgb<span class="sc">$</span>workflow, cs_xgb<span class="sc">$</span>best_tune)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  cs_rf<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>collect_metrics()</code> returns the RMSE, <span class="math inline">\(RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})\)</span> and the model <span class="math inline">\(R^2\)</span>. The RMSE of 1.79 in the test data set is pretty good considering the standard deviation of <code>Sales</code> is 2.74.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric .estimator .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard       1.79  Preprocessor1_Model1
2 rsq     standard       0.660 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>Here is a predicted vs actual plot.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats Random Forest, Predicted vs Actual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-decision_trees_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Fawcett2005" class="csl-entry" role="listitem">
Fawcett, Tom. 2005. <em>An Introduction to ROC Analysis</em>. ELSEVIER. <a href="https://ccrma.stanford.edu/workshops/mir2009/references/ROCintro.pdf">https://ccrma.stanford.edu/workshops/mir2009/references/ROCintro.pdf</a>.
</div>
<div id="ref-James2013" class="csl-entry" role="listitem">
James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2013. <em>An Introduction to Statistical Learning: With Applications in r</em>. 1st ed. New York, NY: Springer. <a href="http://faculty.marshall.usc.edu/gareth-james/ISL/book.html">http://faculty.marshall.usc.edu/gareth-james/ISL/book.html</a>.
</div>
<div id="ref-Kuhn2016" class="csl-entry" role="listitem">
Kuhn, Max, and Kjell Johnson. 2016. <em>Applied Predictive Modeling</em>. 1st ed. New York, NY: Springer. <a href="http://appliedpredictivemodeling.com/">http://appliedpredictivemodeling.com/</a>.
</div>
<div id="ref-Therneau2019" class="csl-entry" role="listitem">
Therneau, Terry, and Elizabeth Atkinson. 2019. <em>An Introduction to Recursive Partitioning Using the RPART Routines</em>. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf">https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf</a>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>These notes rely on <a href="https://online.stat.psu.edu/stat508/">PSU STAT 508</a> and on the <a href="https://www.tidymodels.org/start/">tidymodels vignettes</a> for model building.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>I think for a production system, you would take one more step: re-fit the final model to the entire data set using the hyperparemeter settings from the winning model.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./05-regularization.html" class="pagination-link" aria-label="Regularization">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regularization</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./07-support_vector_machines.html" class="pagination-link" aria-label="Support Vector Machines">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Support Vector Machines</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb86" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Decision Trees</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include=FALSE}</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidymodels)</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="in">library(baguette)</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="in">tidymodels_prefer()</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="in">theme_set(</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_light() +</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="in">      plot.caption = element_text(hjust = 0),</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="in">      strip.background = element_rect(fill="gray90", color="gray60"),</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="in">      strip.text = element_text(color = "gray20")</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="in">scoreboard &lt;- function(dat){</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a><span class="in">   dat %&gt;%</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a><span class="in">      flextable::flextable() %&gt;%</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a><span class="in">      flextable::colformat_num(j = 2, digits = 4) %&gt;%</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a><span class="in">      flextable::autofit()</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>Decision trees, also known as classification and regression tree (CART) models, are tree-based methods for supervised machine learning.^<span class="co">[</span><span class="ot">These notes rely on [PSU STAT 508](https://online.stat.psu.edu/stat508/) and on the [tidymodels vignettes](https://www.tidymodels.org/start/) for model building.</span><span class="co">]</span>  Simple classification trees and regression trees are easy to use and interpret, but are not competitive with the best machine learning methods. However, they form the foundation for ensemble models such as bagged trees, random forests, and boosted trees, which although less interpretable, are very accurate.</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>CART models segment the predictor space into $K$ non-overlapping terminal nodes (leaves). Each node is described by a set of rules which can be used to predict new responses. The predicted value $\hat{y}$ for each node is the mode (classification) or mean (regression).</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>CART models define the nodes through a *top-down greedy* process called *recursive binary splitting*. The process is *top-down* because it begins at the top of the tree with all observations in a single region and successively splits the predictor space. It is *greedy* because at each splitting step, the best split is made at that particular step without consideration to subsequent splits.</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>The best split is the predictor variable and cut point that minimizes a cost function. The most common cost function for regression trees is the sum of squared residuals, </span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>$$RSS = \sum_{k=1}^K\sum_{i \in A_k}{\left(y_i - \hat{y}_{A_k} \right)^2}.$$</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>For classification trees, it is the Gini index, </span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>$$G = \sum_{c=1}^C{\hat{p}_{kc}(1 - \hat{p}_{kc})},$$</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>and the entropy (aka information statistic)</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>$$D = - \sum_{c=1}^C{\hat{p}_{kc} \log \hat{p}_{kc}}$$</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>where $\hat{p}_{kc}$ is the proportion of training observations in node $k$ that are class $c$.  A completely *pure* node in a binary tree would have $\hat{p} \in \{ 0, 1 \}$ and $G = D = 0$. A completely *impure* node in a binary tree would have $\hat{p} = 0.5$ and $G = 0.5^2 \cdot 2 = 0.25$ and $D = -(0.5 \log(0.5)) \cdot 2 = 0.69$.</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>CART repeats the splitting process for each child node until a *stopping criterion* is satisfied, usually when no node size surpasses a predefined maximum, or continued splitting does not improve the model significantly.  CART may also impose a minimum number of observations in each node.</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>The resulting tree likely over-fits the training data and therefore does not generalize well to test data, so CART *prunes* the tree, minimizing the cross-validated prediction error. Rather than cross-validating every possible subtree to find the one with minimum error, CART uses *cost-complexity pruning*. Cost-complexity is the trade off between error (cost) and tree size (complexity) where the trade off is quantified with cost-complexity parameter $c_p$. The cost complexity of the tree, $R_{c_p}(T)$, is the sum of its risk (error) plus a "cost complexity" factor $c_p$ multiple of the tree size $|T|$.  </span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>$$R_{c_p}(T) = R(T) + c_p|T|$$</span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>$c_p$ can take on any value from $<span class="co">[</span><span class="ot">0..\infty</span><span class="co">]</span>$, but it turns out there is an optimal tree for *ranges* of $c_p$ values, so there are only a finite set of *interesting* values for $c_p$ <span class="co">[</span><span class="ot">@James2013</span><span class="co">] [@Therneau2019]</span> <span class="co">[</span><span class="ot">@Kuhn2016</span><span class="co">]</span>.  A parametric algorithm identifies the interesting $c_p$ values and their associated pruned trees, $T_{c_p}$. CART uses cross-validation to determine which $c_p$ is optimal.</span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>The sections in this chapter work through two case studies, using the <span class="in">`ISLR::OJ`</span> data set to fit classification trees and predict which brand of orange juice, Citrus Hill (CH) or Minute Maid = (MM), customers opurchase from its 17 predictor variables, and using the <span class="in">`ISLR::Carseats`</span> data set to predict average sales from its 10 feature variables.</span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message=FALSE}</span></span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a><span class="in">library(rpart.plot)  # better formatted plots than the ones in rpart</span></span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a><span class="in">oj_dat &lt;- ISLR::OJ</span></span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(oj_dat)</span></span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a><span class="in">cs_dat &lt;- ISLR::Carseats</span></span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(cs_dat)</span></span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>Partition the data sets into training and testing sets. Use the training set to estimate parameters, compare models and feature engineering techniques, and tune models. Use the testing set as an unbiased source for measuring final model performance. The test set is held in reserve until the end of the project at which point there are only be one or two models under serious consideration.</span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a><span class="in">(oj_split &lt;- initial_split(oj_dat, prop = 0.8, strata = Purchase))</span></span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a><span class="in">oj_train &lt;- training(oj_split)</span></span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a><span class="in">oj_test &lt;- testing(oj_split)</span></span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a><span class="in">(cs_split &lt;- initial_split(cs_dat, prop = 0.8))</span></span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a><span class="in">cs_train &lt;- training(cs_split)</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a><span class="in">cs_test &lt;- testing(cs_split)</span></span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a><span class="fu">## Classification Tree</span></span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>The simple classification tree is uncommon, but it is the foundation for the more complex ensemble models. </span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>Function <span class="in">`rpart::rpart()`</span> builds a full tree, minimizing the Gini index $G$ by default (<span class="in">`parms = list(split = "gini")`</span>), until the stopping criterion is satisfied.  The default stopping criterion is </span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>only attempt a split if the current node has at least <span class="in">`minsplit = 20`</span> observations, and</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>only accept a split if </span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a><span class="ss">   * </span>the resulting nodes have at least <span class="in">`minbucket = round(minsplit/3)`</span> observations, and </span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a><span class="ss">   * </span>the resulting overall fit improves by <span class="in">`cp = 0.01`</span> (i.e., $\Delta G &lt;= 0.01$).</span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>Some model parameters like <span class="in">`cp`</span> (see <span class="in">`?rpart.control`</span>) are hyperparameters that cannot be optimized directly from the training data set. You can tune hyperparameters by training many models on resampled data sets and exploring how well the models perform. </span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>The <span class="co">[</span><span class="ot">tidymodels vignette</span><span class="co">](https://www.tidymodels.org/start)</span> explains that predictive models should train with resampling methods such as cross-validation to get a short list of candidate models, then choose the best model by comparing performance on the test set. I.e., model selection is a two-phased competition. In this context, we can use CV to fit the best classification tree, then in the next section fit the best bagged tree, then random forest, and so on. The second phase would be to compare all models on the test set.^<span class="co">[</span><span class="ot">I think for a production system, you would take one more step: re-fit the final model to the entire data set using the hyperparemeter settings from the winning model.</span><span class="co">]</span> </span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-cart-class, cache=TRUE}</span></span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a><span class="in">oj_cart &lt;- list()</span></span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a><span class="in"># `decision_tree` has 3 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a><span class="in"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a><span class="in"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a><span class="in">oj_cart$model &lt;-</span></span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a><span class="in">  decision_tree(</span></span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a><span class="in">    cost_complexity = tune(),</span></span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a><span class="in">    tree_depth = tune()</span></span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("rpart") %&gt;%</span></span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("classification")</span></span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a><span class="in">oj_cart$workflow &lt;-</span></span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(oj_cart$model) %&gt;%</span></span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Purchase ~ .)</span></span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a><span class="in">oj_cart$tune_grid &lt;-</span></span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_cart$workflow %&gt;%</span></span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(oj_train, v = 10), </span></span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(cost_complexity(), tree_depth(), levels = 5)</span></span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a><span class="in">oj_cart$tune_grid %&gt;% </span></span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tree_depth = factor(tree_depth)) %&gt;%</span></span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = cost_complexity, y = mean, color = tree_depth)) +</span></span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a>The best models in terms of accuracy and ROC was the tree depth of 4 and any cp &lt; .01.</span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>tune <span class="sc">|&gt;</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>) <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of accuracy and finalize the model.</span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_cart<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-153"><a href="#cb86-153" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-154"><a href="#cb86-154" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_cart<span class="sc">$</span>workflow, oj_cart<span class="sc">$</span>best_tune)</span>
<span id="cb86-155"><a href="#cb86-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-156"><a href="#cb86-156" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-157"><a href="#cb86-157" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-158"><a href="#cb86-158" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-159"><a href="#cb86-159" aria-hidden="true" tabindex="-1"></a>  oj_cart<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-160"><a href="#cb86-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span>
<span id="cb86-161"><a href="#cb86-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-162"><a href="#cb86-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-163"><a href="#cb86-163" aria-hidden="true" tabindex="-1"></a>Here is the tree. The output starts with the root node.  The predicted class at the root is <span class="in">`CH`</span> and this prediction produces 333 errors on the 855 observations for a 61% success rate (accuracy) and 39% error rate. The child nodes of node "x" are labeled 2x) and 2x+1), so the child nodes of 1) are 2) and 3), and the child nodes of 2) are 4) and 5), etc.  Terminal nodes are labeled with an asterisk (*).</span>
<span id="cb86-164"><a href="#cb86-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-167"><a href="#cb86-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-168"><a href="#cb86-168" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">extract_workflow</span>()</span>
<span id="cb86-169"><a href="#cb86-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-170"><a href="#cb86-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-171"><a href="#cb86-171" aria-hidden="true" tabindex="-1"></a>The first split is at <span class="in">`LoyalCH`</span> = 0.48285. Here is a diagram of the tree. The node label indicates the predicted value, error rate, and proportion of observations included. Below the nodes are the splitting criteria.</span>
<span id="cb86-172"><a href="#cb86-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-175"><a href="#cb86-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-176"><a href="#cb86-176" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-177"><a href="#cb86-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-178"><a href="#cb86-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-179"><a href="#cb86-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">yesno =</span> <span class="cn">TRUE</span>, <span class="at">roundint =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-180"><a href="#cb86-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-181"><a href="#cb86-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-182"><a href="#cb86-182" aria-hidden="true" tabindex="-1"></a>The boxes show the node classification (based on mode), the proportion of observations that are *not* <span class="in">`CH`</span>, and the proportion of observations included in the node. </span>
<span id="cb86-183"><a href="#cb86-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-184"><a href="#cb86-184" aria-hidden="true" tabindex="-1"></a><span class="in">`LoyalCH`</span> was the most important variable, followed by <span class="in">`PriceDiff`</span>. A variable's importance is the sum of the improvement in the overall Gini (or RMSE) measure produced by the nodes in which it appears. From the **rpart** <span class="co">[</span><span class="ot">vignette</span><span class="co">](https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf)</span> (page 12), </span>
<span id="cb86-185"><a href="#cb86-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-186"><a href="#cb86-186" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; "An overall measure of variable importance is the sum of the goodness of split measures for each split for which it was the primary variable, plus goodness (adjusted agreement) for all splits in which it was a surrogate."</span></span>
<span id="cb86-187"><a href="#cb86-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-190"><a href="#cb86-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-191"><a href="#cb86-191" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-192"><a href="#cb86-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-193"><a href="#cb86-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-194"><a href="#cb86-194" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>()</span>
<span id="cb86-195"><a href="#cb86-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-196"><a href="#cb86-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-197"><a href="#cb86-197" aria-hidden="true" tabindex="-1"></a><span class="fu">### Measuring Performance {-}</span></span>
<span id="cb86-198"><a href="#cb86-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-199"><a href="#cb86-199" aria-hidden="true" tabindex="-1"></a><span class="in">`collect_metrics()`</span> shows the accuracy and ROC AUC metrics. </span>
<span id="cb86-200"><a href="#cb86-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-203"><a href="#cb86-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-204"><a href="#cb86-204" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-205"><a href="#cb86-205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-206"><a href="#cb86-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-207"><a href="#cb86-207" aria-hidden="true" tabindex="-1"></a>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve.</span>
<span id="cb86-208"><a href="#cb86-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-209"><a href="#cb86-209" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Confusion Matrix {-}</span></span>
<span id="cb86-210"><a href="#cb86-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-211"><a href="#cb86-211" aria-hidden="true" tabindex="-1"></a>The confusion matrix calculates the model performance predicting on the holdout testing data set.</span>
<span id="cb86-212"><a href="#cb86-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-213"><a href="#cb86-213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb86-214"><a href="#cb86-214" aria-hidden="true" tabindex="-1"></a><span class="in">oj_cart$confmat &lt;-</span></span>
<span id="cb86-215"><a href="#cb86-215" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_cart$fit %&gt;% </span></span>
<span id="cb86-216"><a href="#cb86-216" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_predictions() %&gt;% </span></span>
<span id="cb86-217"><a href="#cb86-217" aria-hidden="true" tabindex="-1"></a><span class="in">  conf_mat(truth = Purchase, estimate = .pred_class)</span></span>
<span id="cb86-218"><a href="#cb86-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-219"><a href="#cb86-219" aria-hidden="true" tabindex="-1"></a><span class="in"># oj_cart$preds &lt;- </span></span>
<span id="cb86-220"><a href="#cb86-220" aria-hidden="true" tabindex="-1"></a><span class="in">#   bind_cols(</span></span>
<span id="cb86-221"><a href="#cb86-221" aria-hidden="true" tabindex="-1"></a><span class="in">#      predict(oj_cart$fit, new_data = oj_test, type = "prob"),</span></span>
<span id="cb86-222"><a href="#cb86-222" aria-hidden="true" tabindex="-1"></a><span class="in">#      predicted = predict(oj_cart$fit, new_data = oj_test, type = "class"),</span></span>
<span id="cb86-223"><a href="#cb86-223" aria-hidden="true" tabindex="-1"></a><span class="in">#      actual = oj_test$Purchase</span></span>
<span id="cb86-224"><a href="#cb86-224" aria-hidden="true" tabindex="-1"></a><span class="in">#   )</span></span>
<span id="cb86-225"><a href="#cb86-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-226"><a href="#cb86-226" aria-hidden="true" tabindex="-1"></a><span class="in">oj_cart$confmat</span></span>
<span id="cb86-227"><a href="#cb86-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-228"><a href="#cb86-228" aria-hidden="true" tabindex="-1"></a><span class="in">summary(oj_cart$confmat)</span></span>
<span id="cb86-229"><a href="#cb86-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-230"><a href="#cb86-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-231"><a href="#cb86-231" aria-hidden="true" tabindex="-1"></a>You can bound the accuracy with a 95% CI using the binomial test.</span>
<span id="cb86-232"><a href="#cb86-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-235"><a href="#cb86-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-236"><a href="#cb86-236" aria-hidden="true" tabindex="-1"></a><span class="fu">binom.test</span>(</span>
<span id="cb86-237"><a href="#cb86-237" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table <span class="sc">%&gt;%</span> <span class="fu">diag</span>() <span class="sc">%&gt;%</span> <span class="fu">sum</span>(), </span>
<span id="cb86-238"><a href="#cb86-238" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table <span class="sc">%&gt;%</span> <span class="fu">sum</span>()</span>
<span id="cb86-239"><a href="#cb86-239" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-240"><a href="#cb86-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-241"><a href="#cb86-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-242"><a href="#cb86-242" aria-hidden="true" tabindex="-1"></a>The detection prevalence (aka, no information rate (NIR)) statistic is the class rate for the largest class. In this case CH is the largest class, so NIR = 133/213 = 0.6186. The binomial test for NIR is the probability of that the model accuracy is significantly better than the NIR (i.e., significantly better than just always guessing CH).</span>
<span id="cb86-243"><a href="#cb86-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-246"><a href="#cb86-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-247"><a href="#cb86-247" aria-hidden="true" tabindex="-1"></a><span class="fu">binom.test</span>(</span>
<span id="cb86-248"><a href="#cb86-248" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table[<span class="st">"CH"</span>, ] <span class="sc">%&gt;%</span> <span class="fu">sum</span>(), </span>
<span id="cb86-249"><a href="#cb86-249" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table <span class="sc">%&gt;%</span> <span class="fu">sum</span>(),</span>
<span id="cb86-250"><a href="#cb86-250" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table[, <span class="st">"CH"</span>]) <span class="sc">/</span> <span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table),</span>
<span id="cb86-251"><a href="#cb86-251" aria-hidden="true" tabindex="-1"></a>  <span class="at">alternative =</span> <span class="st">"greater"</span></span>
<span id="cb86-252"><a href="#cb86-252" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-253"><a href="#cb86-253" aria-hidden="true" tabindex="-1"></a><span class="fu">binom.test</span>(<span class="at">x =</span> <span class="dv">116</span> <span class="sc">+</span> <span class="dv">67</span>, <span class="at">n =</span> <span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table), </span>
<span id="cb86-254"><a href="#cb86-254" aria-hidden="true" tabindex="-1"></a>           <span class="at">p =</span> (<span class="dv">116</span><span class="sc">+</span><span class="dv">17</span>)<span class="sc">/</span><span class="fu">sum</span>(oj_cart<span class="sc">$</span>confmat<span class="sc">$</span>table), </span>
<span id="cb86-255"><a href="#cb86-255" aria-hidden="true" tabindex="-1"></a>           <span class="at">alternative =</span> <span class="st">"greater"</span>)</span>
<span id="cb86-256"><a href="#cb86-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-257"><a href="#cb86-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-258"><a href="#cb86-258" aria-hidden="true" tabindex="-1"></a>The accuracy statistic indicates the model predicts <span class="in">`r summary(oj_cart$confmat) %&gt;% filter(.metric == "accuracy") %&gt;% pull(.estimate) %&gt;% percent(.1)`</span> of the observations correctly. That's good, but less impressive when you consider the prevalence of CH is <span class="in">`r (sum(oj_cart$confmat$table[1, ]) / sum(oj_cart$confmat$table)) %&gt;% percent(.1)`</span> - you could achieve that accuracy just by predicting CH every time. A measure that controls for the prevalence is Cohen's kappa statistic. The kappa statistic is explained <span class="co">[</span><span class="ot">here</span><span class="co">](https://standardwisdom.com/softwarejournal/2011/12/confusion-matrix-another-single-value-metric-kappa-statistic/)</span>. It compares the accuracy to the accuracy of a "random system". It is defined as</span>
<span id="cb86-259"><a href="#cb86-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-260"><a href="#cb86-260" aria-hidden="true" tabindex="-1"></a>$$\kappa = \frac{\text{Accuracy} - RA}{1-RA}$$</span>
<span id="cb86-261"><a href="#cb86-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-262"><a href="#cb86-262" aria-hidden="true" tabindex="-1"></a>where </span>
<span id="cb86-263"><a href="#cb86-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-264"><a href="#cb86-264" aria-hidden="true" tabindex="-1"></a>$$RA = \frac{\text{ActFalse} \times \text{PredFalse} + \text{ActTrue} \times \text{PredTrue}}{\text{Total} \times \text{Total}}$$</span>
<span id="cb86-265"><a href="#cb86-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-266"><a href="#cb86-266" aria-hidden="true" tabindex="-1"></a>is the hypothetical probability of a chance agreement. </span>
<span id="cb86-267"><a href="#cb86-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-268"><a href="#cb86-268" aria-hidden="true" tabindex="-1"></a>The kappa statistic varies from 0 to 1 where 0 means accurate predictions occur merely by chance, and 1 means the predictions are in perfect agreement with the observations.  In this case, a kappa statistic of 0.7064 is "substantial".  See chart <span class="co">[</span><span class="ot">here</span><span class="co">](https://www.statisticshowto.datasciencecentral.com/cohens-kappa-statistic/)</span>.</span>
<span id="cb86-269"><a href="#cb86-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-270"><a href="#cb86-270" aria-hidden="true" tabindex="-1"></a>You can remind yourself what the other confusion matrix measures are from the documentation. Visuals are almost always helpful. Here is a plot of the confusion matrix.</span>
<span id="cb86-271"><a href="#cb86-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-274"><a href="#cb86-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-275"><a href="#cb86-275" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb86-276"><a href="#cb86-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb86-277"><a href="#cb86-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Purchase, .pred_class) <span class="sc">%&gt;%</span></span>
<span id="cb86-278"><a href="#cb86-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb86-279"><a href="#cb86-279" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Simple Classification: Predicted vs. Actual"</span>,</span>
<span id="cb86-280"><a href="#cb86-280" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Actual"</span>,</span>
<span id="cb86-281"><a href="#cb86-281" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Predicted"</span></span>
<span id="cb86-282"><a href="#cb86-282" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-283"><a href="#cb86-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-284"><a href="#cb86-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-285"><a href="#cb86-285" aria-hidden="true" tabindex="-1"></a><span class="fu">#### ROC Curve {-}</span></span>
<span id="cb86-286"><a href="#cb86-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-287"><a href="#cb86-287" aria-hidden="true" tabindex="-1"></a>The ROC (receiver operating characteristics) curve <span class="co">[</span><span class="ot">@Fawcett2005</span><span class="co">]</span> is another measure of accuracy. The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. By default, the threshold for predicting the default classification is 0.50, but it could be any threshold. <span class="in">`precrec::evalmod()`</span> calculates the confusion matrix values from the model using the holdout data set. The AUC on the holdout set is <span class="in">`r oj_cart$fit %&gt;% collect_predictions() %&gt;% yardstick::roc_auc(Purchase, .pred_CH) %&gt;% pull(.estimate) %&gt;% comma(.001)`</span>. <span class="in">`pRoc::plot.roc()`</span>, <span class="in">`plotROC::geom_roc()`</span>, and <span class="in">`yardstick::roc_curve()`</span> are options for plotting a ROC curve.</span>
<span id="cb86-288"><a href="#cb86-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-291"><a href="#cb86-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-292"><a href="#cb86-292" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-293"><a href="#cb86-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-294"><a href="#cb86-294" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-295"><a href="#cb86-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-296"><a href="#cb86-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ CART ROC Curve"</span>)</span>
<span id="cb86-297"><a href="#cb86-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-298"><a href="#cb86-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-299"><a href="#cb86-299" aria-hidden="true" tabindex="-1"></a>A few points on the ROC space are helpful for understanding how to use it.  </span>
<span id="cb86-300"><a href="#cb86-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-301"><a href="#cb86-301" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The lower left point (0, 0) is the result of *always* predicting "negative" or in this case "MM" if "CH" is taken as the default class. No false positives, but no true positives either.</span>
<span id="cb86-302"><a href="#cb86-302" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The upper right point (1, 1) is the result of *always* predicting "positive" ("CH" here).  You catch all true positives, but miss all the true negatives.</span>
<span id="cb86-303"><a href="#cb86-303" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The upper left point (0, 1) is the result of perfect accuracy.</span>
<span id="cb86-304"><a href="#cb86-304" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The lower right point (1, 0) is the result of perfect imbecility. You made the exact wrong prediction every time. </span>
<span id="cb86-305"><a href="#cb86-305" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The 45 degree diagonal is the result of randomly guessing positive (CH) X percent of the time.  If you guess positive 90% of the time and the prevalence is 50%, your TPR will be 90% and your FPR will also be 90%, etc.</span>
<span id="cb86-306"><a href="#cb86-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-307"><a href="#cb86-307" aria-hidden="true" tabindex="-1"></a>The goal is for all nodes to bunch up in the upper left.</span>
<span id="cb86-308"><a href="#cb86-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-309"><a href="#cb86-309" aria-hidden="true" tabindex="-1"></a>Points to the left of the diagonal with a low TPR can be thought of as "conservative" predictors - they only make positive (CH) predictions with strong evidence.  Points to the left of the diagonal with a high TPR can be thought of as "liberal" predictors - they make positive (CH) predictions with weak evidence.</span>
<span id="cb86-310"><a href="#cb86-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-311"><a href="#cb86-311" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Gain Curve</span></span>
<span id="cb86-312"><a href="#cb86-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-313"><a href="#cb86-313" aria-hidden="true" tabindex="-1"></a>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value. The “wizard” curve is the gain curve when the data is sorted by the true outcome. If the model’s gain curve is close to the wizard curve, then the model predicted the response variable well. The gray area is the “gain” over a random prediction.</span>
<span id="cb86-314"><a href="#cb86-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-315"><a href="#cb86-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include=FALSE}</span></span>
<span id="cb86-316"><a href="#cb86-316" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- oj_cart$fit %&gt;% collect_predictions() %&gt;% yardstick::gain_curve(Purchase, .pred_CH)</span></span>
<span id="cb86-317"><a href="#cb86-317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-318"><a href="#cb86-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-319"><a href="#cb86-319" aria-hidden="true" tabindex="-1"></a><span class="in">`r sum(oj_test$Purchase == "CH")`</span> of the <span class="in">`r nrow(oj_test)`</span> consumers in the holdout testing set purchased CH.</span>
<span id="cb86-320"><a href="#cb86-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-323"><a href="#cb86-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-324"><a href="#cb86-324" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-325"><a href="#cb86-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-326"><a href="#cb86-326" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH)</span>
<span id="cb86-327"><a href="#cb86-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-328"><a href="#cb86-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-329"><a href="#cb86-329" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The gain curve encountered <span class="in">`r x[2, ]$.n_events`</span> CH purchasers (<span class="in">`r x[2, ]$.percent_found %&gt;% comma(.1)`</span>%) within the first <span class="in">`r x[2, ]$.n`</span> observations (<span class="in">`r x[2, ]$.percent_tested %&gt;% comma(.1)`</span>%). </span>
<span id="cb86-330"><a href="#cb86-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-331"><a href="#cb86-331" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>It encountered all <span class="in">`r sum(oj_test$Purchase == "CH")`</span> CH purchasers on the <span class="in">`r x[8, ]$.n`</span>th observation (100%).</span>
<span id="cb86-332"><a href="#cb86-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-333"><a href="#cb86-333" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The bottom of the gray area is the outcome of a random model. Only half the CH purchasers would be observed within 50% of the observations. The top of the gray area is the outcome of the perfect model, the “wizard curve”. Half the CH purchasers would be observed in ~30% of the observations.</span>
<span id="cb86-334"><a href="#cb86-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-337"><a href="#cb86-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-338"><a href="#cb86-338" aria-hidden="true" tabindex="-1"></a>oj_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-339"><a href="#cb86-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-340"><a href="#cb86-340" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-341"><a href="#cb86-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-342"><a href="#cb86-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ CART Gain Curve"</span>)</span>
<span id="cb86-343"><a href="#cb86-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-344"><a href="#cb86-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-345"><a href="#cb86-345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regression Tree</span></span>
<span id="cb86-346"><a href="#cb86-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-347"><a href="#cb86-347" aria-hidden="true" tabindex="-1"></a>A simple regression tree is built in a manner similar to a simple classification tree, and like the simple classification tree, it is rarely invoked on its own; the bagged, random forest, and gradient boosting methods build on this logic.  </span>
<span id="cb86-348"><a href="#cb86-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-349"><a href="#cb86-349" aria-hidden="true" tabindex="-1"></a>The first step is to build a full tree, then perform k-fold cross-validation to help select the optimal cost complexity (cp). The only difference here is the <span class="in">`set_Mode("regression")`</span> call to produce a regression tree.</span>
<span id="cb86-350"><a href="#cb86-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-351"><a href="#cb86-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-cart-reg, cache=TRUE}</span></span>
<span id="cb86-352"><a href="#cb86-352" aria-hidden="true" tabindex="-1"></a><span class="in">cs_cart &lt;- list()</span></span>
<span id="cb86-353"><a href="#cb86-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-354"><a href="#cb86-354" aria-hidden="true" tabindex="-1"></a><span class="in"># `decision_tree` has 3 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb86-355"><a href="#cb86-355" aria-hidden="true" tabindex="-1"></a><span class="in"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb86-356"><a href="#cb86-356" aria-hidden="true" tabindex="-1"></a><span class="in"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb86-357"><a href="#cb86-357" aria-hidden="true" tabindex="-1"></a><span class="in">cs_cart$model &lt;-</span></span>
<span id="cb86-358"><a href="#cb86-358" aria-hidden="true" tabindex="-1"></a><span class="in">  decision_tree(</span></span>
<span id="cb86-359"><a href="#cb86-359" aria-hidden="true" tabindex="-1"></a><span class="in">    cost_complexity = tune(),</span></span>
<span id="cb86-360"><a href="#cb86-360" aria-hidden="true" tabindex="-1"></a><span class="in">    tree_depth = tune()</span></span>
<span id="cb86-361"><a href="#cb86-361" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-362"><a href="#cb86-362" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("rpart") %&gt;%</span></span>
<span id="cb86-363"><a href="#cb86-363" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("regression")</span></span>
<span id="cb86-364"><a href="#cb86-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-365"><a href="#cb86-365" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-366"><a href="#cb86-366" aria-hidden="true" tabindex="-1"></a><span class="in">cs_cart$workflow &lt;-</span></span>
<span id="cb86-367"><a href="#cb86-367" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-368"><a href="#cb86-368" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(cs_cart$model) %&gt;%</span></span>
<span id="cb86-369"><a href="#cb86-369" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Sales ~ .)</span></span>
<span id="cb86-370"><a href="#cb86-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-371"><a href="#cb86-371" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-372"><a href="#cb86-372" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-373"><a href="#cb86-373" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-374"><a href="#cb86-374" aria-hidden="true" tabindex="-1"></a><span class="in">cs_cart$tune_grid &lt;-</span></span>
<span id="cb86-375"><a href="#cb86-375" aria-hidden="true" tabindex="-1"></a><span class="in">  cs_cart$workflow %&gt;%</span></span>
<span id="cb86-376"><a href="#cb86-376" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-377"><a href="#cb86-377" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(cs_train, v = 10), </span></span>
<span id="cb86-378"><a href="#cb86-378" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(cost_complexity(), tree_depth(), levels = 5)</span></span>
<span id="cb86-379"><a href="#cb86-379" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-380"><a href="#cb86-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-381"><a href="#cb86-381" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: rmse and rsq.</span></span>
<span id="cb86-382"><a href="#cb86-382" aria-hidden="true" tabindex="-1"></a><span class="in">cs_cart$tune_grid %&gt;% </span></span>
<span id="cb86-383"><a href="#cb86-383" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-384"><a href="#cb86-384" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tree_depth = factor(tree_depth)) %&gt;%</span></span>
<span id="cb86-385"><a href="#cb86-385" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = cost_complexity, y = mean, color = tree_depth)) +</span></span>
<span id="cb86-386"><a href="#cb86-386" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-387"><a href="#cb86-387" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-388"><a href="#cb86-388" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-389"><a href="#cb86-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-390"><a href="#cb86-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-391"><a href="#cb86-391" aria-hidden="true" tabindex="-1"></a>The best models in terms of RMSE was the tree depth of 8 and any cp &lt; 5.6E-04.</span>
<span id="cb86-392"><a href="#cb86-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-395"><a href="#cb86-395" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-396"><a href="#cb86-396" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-397"><a href="#cb86-397" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-398"><a href="#cb86-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-399"><a href="#cb86-399" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of rmse and finalize the model. </span>
<span id="cb86-400"><a href="#cb86-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-403"><a href="#cb86-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-404"><a href="#cb86-404" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_cart<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-405"><a href="#cb86-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-406"><a href="#cb86-406" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-407"><a href="#cb86-407" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_cart<span class="sc">$</span>workflow, cs_cart<span class="sc">$</span>best_tune)</span>
<span id="cb86-408"><a href="#cb86-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-409"><a href="#cb86-409" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-410"><a href="#cb86-410" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-411"><a href="#cb86-411" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-412"><a href="#cb86-412" aria-hidden="true" tabindex="-1"></a>  cs_cart<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-413"><a href="#cb86-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span>
<span id="cb86-414"><a href="#cb86-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-415"><a href="#cb86-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-416"><a href="#cb86-416" aria-hidden="true" tabindex="-1"></a>Here is the tree. The output starts with the root node. The predicted sales at the root is the mean sales in the testing data set is <span class="in">`r cs_cart$fit %&gt;% extract_workflow() %&gt;% pluck("fit", "fit", "fit", "frame") %&gt;% filter(var == "ShelveLoc") %&gt;% head(1) %&gt;% pull(yval) %&gt;% comma(.01)`</span> (values are \$000s). The deviance at the root is the SSE, <span class="in">`r cs_cart$fit %&gt;% extract_workflow() %&gt;% pluck("fit", "fit", "fit", "frame") %&gt;% filter(var == "ShelveLoc") %&gt;% head(1) %&gt;% pull(dev) %&gt;% comma(1)`</span>. The first split is at <span class="in">`ShelveLoc`</span> = <span class="co">[</span><span class="ot">Bad, Medium</span><span class="co">]</span> vs Good.</span>
<span id="cb86-417"><a href="#cb86-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-420"><a href="#cb86-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-421"><a href="#cb86-421" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">extract_workflow</span>()</span>
<span id="cb86-422"><a href="#cb86-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-423"><a href="#cb86-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-424"><a href="#cb86-424" aria-hidden="true" tabindex="-1"></a>Here is a diagram of the tree. The node label indicates the predicted value (mean) and the proportion of observations that are in the node (or child nodes). Below the nodes are the splitting criteria.</span>
<span id="cb86-425"><a href="#cb86-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-428"><a href="#cb86-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-429"><a href="#cb86-429" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-430"><a href="#cb86-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-431"><a href="#cb86-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-432"><a href="#cb86-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">yesno =</span> <span class="cn">TRUE</span>, <span class="at">roundint =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-433"><a href="#cb86-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-434"><a href="#cb86-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-435"><a href="#cb86-435" aria-hidden="true" tabindex="-1"></a><span class="in">`Price`</span> and <span class="in">`ShelveLoc`</span> were the most important variables.</span>
<span id="cb86-436"><a href="#cb86-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-439"><a href="#cb86-439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-440"><a href="#cb86-440" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-441"><a href="#cb86-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-442"><a href="#cb86-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-443"><a href="#cb86-443" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>()</span>
<span id="cb86-444"><a href="#cb86-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-445"><a href="#cb86-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-446"><a href="#cb86-446" aria-hidden="true" tabindex="-1"></a><span class="fu">### Measuring Performance {-}</span></span>
<span id="cb86-447"><a href="#cb86-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-448"><a href="#cb86-448" aria-hidden="true" tabindex="-1"></a><span class="in">`collect_metrics()`</span> returns the RMSE, $RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})$ and the model $R^2$. The RMSE of <span class="in">`r cs_cart$fit %&gt;% collect_metrics() %&gt;% filter(.metric == "rmse") %&gt;% pull(.estimate) %&gt;% comma(.01)`</span> in the test data set is pretty good considering the standard deviation of <span class="in">`Sales`</span> is <span class="in">`r comma(sd(cs_test$Sales), .01)`</span>.</span>
<span id="cb86-449"><a href="#cb86-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-452"><a href="#cb86-452" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-453"><a href="#cb86-453" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-454"><a href="#cb86-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-455"><a href="#cb86-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-456"><a href="#cb86-456" aria-hidden="true" tabindex="-1"></a>Here is a predicted vs actual plot. </span>
<span id="cb86-457"><a href="#cb86-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-460"><a href="#cb86-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-461"><a href="#cb86-461" aria-hidden="true" tabindex="-1"></a>cs_cart<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb86-462"><a href="#cb86-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-463"><a href="#cb86-463" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb86-464"><a href="#cb86-464" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb86-465"><a href="#cb86-465" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb86-466"><a href="#cb86-466" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb86-467"><a href="#cb86-467" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats CART, Predicted vs Actual"</span>)</span>
<span id="cb86-468"><a href="#cb86-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-469"><a href="#cb86-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-470"><a href="#cb86-470" aria-hidden="true" tabindex="-1"></a>The tree nodes do a decent job of binning the observations. The predictions vs actuals plot suggests the model over-estimates at the low end and underestimates at the high end. Calculate the test data set RMSE.</span>
<span id="cb86-471"><a href="#cb86-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-472"><a href="#cb86-472" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bagged Trees</span></span>
<span id="cb86-473"><a href="#cb86-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-474"><a href="#cb86-474" aria-hidden="true" tabindex="-1"></a>One drawback of decision trees is that they are high-variance estimators. A small number of additional training observations can dramatically alter the prediction performance of a learned tree.</span>
<span id="cb86-475"><a href="#cb86-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-476"><a href="#cb86-476" aria-hidden="true" tabindex="-1"></a>Bootstrap aggregation, or *bagging*, is a general-purpose procedure for reducing the variance of a statistical learning method.  The algorithm constructs *B* regression trees using *B* bootstrapped training sets, and averages the resulting predictions. These trees are grown deep, and are not pruned. Hence each individual tree has high variance, but low bias. Averaging the *B* trees reduces the variance.  The predicted value for an observation is the mode (classification) or mean (regression) of the trees. *B* usually equals ~25.</span>
<span id="cb86-477"><a href="#cb86-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-478"><a href="#cb86-478" aria-hidden="true" tabindex="-1"></a>To test the model accuracy, the out-of-bag observations are predicted from the models. For a training set of size *n*, each tree is composed of $\sim (1 - e^{-1})n = .632n$ unique observations in-bag and $.368n$ out-of-bag. For each tree in the ensemble, bagging makes predictions on the tree's out-of-bag observations. I think (*see* page 197 of [@Kuhn2016]) bagging measures the performance (RMSE, Accuracy, ROC, etc.) of each tree in the ensemble and averages them to produce an overall performance estimate. (This makes no sense to me. If each tree has poor performance, then the average performance of many trees will still be poor. An ensemble of *B* trees will produce $\sim .368 B$ predictions per unique observation. Seems like you should take the mean/mode of each observation's prediction as the final prediction. Then you have *n* predictions to compare to *n* actuals, and you assess performance on that.)</span>
<span id="cb86-479"><a href="#cb86-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-480"><a href="#cb86-480" aria-hidden="true" tabindex="-1"></a>The downside to bagging is that there is no single tree with a set of rules to interpret. It becomes unclear which variables are more important than others. </span>
<span id="cb86-481"><a href="#cb86-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-482"><a href="#cb86-482" aria-hidden="true" tabindex="-1"></a>The next section explains how bagged trees are a special case of random forests.</span>
<span id="cb86-483"><a href="#cb86-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-484"><a href="#cb86-484" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bagged Classification Tree</span></span>
<span id="cb86-485"><a href="#cb86-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-486"><a href="#cb86-486" aria-hidden="true" tabindex="-1"></a>Leaning by example, I'll predict <span class="in">`Purchase`</span> from the <span class="in">`OJ`</span> data set again, this time using the bagging with <span class="in">`parsnip::bag_tree()`</span>.</span>
<span id="cb86-487"><a href="#cb86-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-488"><a href="#cb86-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-bag-class, cache=TRUE}</span></span>
<span id="cb86-489"><a href="#cb86-489" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag &lt;- list()</span></span>
<span id="cb86-490"><a href="#cb86-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-491"><a href="#cb86-491" aria-hidden="true" tabindex="-1"></a><span class="in"># `bag_tree` has 4 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb86-492"><a href="#cb86-492" aria-hidden="true" tabindex="-1"></a><span class="in"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb86-493"><a href="#cb86-493" aria-hidden="true" tabindex="-1"></a><span class="in"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb86-494"><a href="#cb86-494" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag$model &lt;-</span></span>
<span id="cb86-495"><a href="#cb86-495" aria-hidden="true" tabindex="-1"></a><span class="in">  bag_tree(</span></span>
<span id="cb86-496"><a href="#cb86-496" aria-hidden="true" tabindex="-1"></a><span class="in">    cost_complexity = tune(),</span></span>
<span id="cb86-497"><a href="#cb86-497" aria-hidden="true" tabindex="-1"></a><span class="in">    tree_depth = tune()</span></span>
<span id="cb86-498"><a href="#cb86-498" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-499"><a href="#cb86-499" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("rpart") %&gt;%</span></span>
<span id="cb86-500"><a href="#cb86-500" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("classification")</span></span>
<span id="cb86-501"><a href="#cb86-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-502"><a href="#cb86-502" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-503"><a href="#cb86-503" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag$workflow &lt;-</span></span>
<span id="cb86-504"><a href="#cb86-504" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-505"><a href="#cb86-505" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(oj_bag$model) %&gt;%</span></span>
<span id="cb86-506"><a href="#cb86-506" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Purchase ~ .)</span></span>
<span id="cb86-507"><a href="#cb86-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-508"><a href="#cb86-508" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-509"><a href="#cb86-509" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-510"><a href="#cb86-510" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-511"><a href="#cb86-511" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag$tune_grid &lt;-</span></span>
<span id="cb86-512"><a href="#cb86-512" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_bag$workflow %&gt;%</span></span>
<span id="cb86-513"><a href="#cb86-513" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-514"><a href="#cb86-514" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(oj_train, v = 10), </span></span>
<span id="cb86-515"><a href="#cb86-515" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(cost_complexity(), tree_depth(), levels = 5)</span></span>
<span id="cb86-516"><a href="#cb86-516" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-517"><a href="#cb86-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-518"><a href="#cb86-518" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb86-519"><a href="#cb86-519" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag$tune_grid %&gt;% </span></span>
<span id="cb86-520"><a href="#cb86-520" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-521"><a href="#cb86-521" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tree_depth = factor(tree_depth)) %&gt;%</span></span>
<span id="cb86-522"><a href="#cb86-522" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = cost_complexity, y = mean, color = tree_depth)) +</span></span>
<span id="cb86-523"><a href="#cb86-523" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-524"><a href="#cb86-524" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-525"><a href="#cb86-525" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-526"><a href="#cb86-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-527"><a href="#cb86-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-528"><a href="#cb86-528" aria-hidden="true" tabindex="-1"></a>The best models in terms of accuracy and ROC was the tree depth of 4 and any cp &lt;= 3.16e-06.</span>
<span id="cb86-529"><a href="#cb86-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-532"><a href="#cb86-532" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-533"><a href="#cb86-533" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb86-534"><a href="#cb86-534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-535"><a href="#cb86-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-536"><a href="#cb86-536" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of accuracy and finalize the model.</span>
<span id="cb86-537"><a href="#cb86-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-540"><a href="#cb86-540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-541"><a href="#cb86-541" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_bag<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb86-542"><a href="#cb86-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-543"><a href="#cb86-543" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-544"><a href="#cb86-544" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_bag<span class="sc">$</span>workflow, oj_bag<span class="sc">$</span>best_tune)</span>
<span id="cb86-545"><a href="#cb86-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-546"><a href="#cb86-546" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-547"><a href="#cb86-547" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-548"><a href="#cb86-548" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-549"><a href="#cb86-549" aria-hidden="true" tabindex="-1"></a>  oj_bag<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-550"><a href="#cb86-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span>
<span id="cb86-551"><a href="#cb86-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-552"><a href="#cb86-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-553"><a href="#cb86-553" aria-hidden="true" tabindex="-1"></a>I *think* tidymodels started by splitting the training set into 10 folds, then using 9 of the folds to run the bagging algorithm and collect performance measures on the hold-out fold. After repeating the process for all 10 folds, it averaged the performance measures to produce the resampling results shown below. With hyperparameters, the process is repeated for all combinations and the resampling results above are from the best performing combination.</span>
<span id="cb86-554"><a href="#cb86-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-555"><a href="#cb86-555" aria-hidden="true" tabindex="-1"></a>There is no single tree to visualize, and you can't even produce a VIP. Let's look at the performance on the holdout data set. <span class="in">`collect_metrics()`</span> shows the accuracy and ROC AUC metrics. The accuracy is slightly lower than the single tree, but ROC AUC is higher.</span>
<span id="cb86-556"><a href="#cb86-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-559"><a href="#cb86-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-560"><a href="#cb86-560" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-561"><a href="#cb86-561" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-562"><a href="#cb86-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-563"><a href="#cb86-563" aria-hidden="true" tabindex="-1"></a>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve. The confusion matrix calculates the model performance predicting on the holdout testing data set.</span>
<span id="cb86-564"><a href="#cb86-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-565"><a href="#cb86-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb86-566"><a href="#cb86-566" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag$confmat &lt;-</span></span>
<span id="cb86-567"><a href="#cb86-567" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_bag$fit %&gt;% </span></span>
<span id="cb86-568"><a href="#cb86-568" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_predictions() %&gt;% </span></span>
<span id="cb86-569"><a href="#cb86-569" aria-hidden="true" tabindex="-1"></a><span class="in">  conf_mat(truth = Purchase, estimate = .pred_class)</span></span>
<span id="cb86-570"><a href="#cb86-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-571"><a href="#cb86-571" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag$confmat</span></span>
<span id="cb86-572"><a href="#cb86-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-573"><a href="#cb86-573" aria-hidden="true" tabindex="-1"></a><span class="in">summary(oj_bag$confmat)</span></span>
<span id="cb86-574"><a href="#cb86-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-575"><a href="#cb86-575" aria-hidden="true" tabindex="-1"></a><span class="in">oj_bag$fit %&gt;% </span></span>
<span id="cb86-576"><a href="#cb86-576" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_predictions() %&gt;% </span></span>
<span id="cb86-577"><a href="#cb86-577" aria-hidden="true" tabindex="-1"></a><span class="in">  select(Purchase, .pred_class) %&gt;%</span></span>
<span id="cb86-578"><a href="#cb86-578" aria-hidden="true" tabindex="-1"></a><span class="in">  plot(</span></span>
<span id="cb86-579"><a href="#cb86-579" aria-hidden="true" tabindex="-1"></a><span class="in">    main = "Bagged Trees: Predicted vs. Actual",</span></span>
<span id="cb86-580"><a href="#cb86-580" aria-hidden="true" tabindex="-1"></a><span class="in">    xlab = "Actual",</span></span>
<span id="cb86-581"><a href="#cb86-581" aria-hidden="true" tabindex="-1"></a><span class="in">    ylab = "Predicted"</span></span>
<span id="cb86-582"><a href="#cb86-582" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-583"><a href="#cb86-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-584"><a href="#cb86-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-585"><a href="#cb86-585" aria-hidden="true" tabindex="-1"></a>The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. The AUC on the holdout set is <span class="in">`r oj_bag$fit %&gt;% collect_predictions() %&gt;% yardstick::roc_auc(Purchase, .pred_CH) %&gt;% pull(.estimate) %&gt;% comma(.001)`</span>.</span>
<span id="cb86-586"><a href="#cb86-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-589"><a href="#cb86-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-590"><a href="#cb86-590" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-591"><a href="#cb86-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-592"><a href="#cb86-592" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-593"><a href="#cb86-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-594"><a href="#cb86-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Bagged Trees ROC Curve"</span>)</span>
<span id="cb86-595"><a href="#cb86-595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-596"><a href="#cb86-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-597"><a href="#cb86-597" aria-hidden="true" tabindex="-1"></a>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value. </span>
<span id="cb86-598"><a href="#cb86-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-601"><a href="#cb86-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-602"><a href="#cb86-602" aria-hidden="true" tabindex="-1"></a>oj_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-603"><a href="#cb86-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-604"><a href="#cb86-604" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-605"><a href="#cb86-605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-606"><a href="#cb86-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Bagged Trees Gain Curve"</span>)</span>
<span id="cb86-607"><a href="#cb86-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-608"><a href="#cb86-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-609"><a href="#cb86-609" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bagging Regression Tree</span></span>
<span id="cb86-610"><a href="#cb86-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-611"><a href="#cb86-611" aria-hidden="true" tabindex="-1"></a>I'll predict <span class="in">`Sales`</span> from the <span class="in">`Carseats`</span> data set again, this time with <span class="in">`parsnip::bag_tree()`</span>.</span>
<span id="cb86-612"><a href="#cb86-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-613"><a href="#cb86-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-bag-reg, cache=TRUE}</span></span>
<span id="cb86-614"><a href="#cb86-614" aria-hidden="true" tabindex="-1"></a><span class="in">library(baguette)</span></span>
<span id="cb86-615"><a href="#cb86-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-616"><a href="#cb86-616" aria-hidden="true" tabindex="-1"></a><span class="in">cs_bag &lt;- list()</span></span>
<span id="cb86-617"><a href="#cb86-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-618"><a href="#cb86-618" aria-hidden="true" tabindex="-1"></a><span class="in"># `bag_tree` has 4 hyperparameters (`cost_complexity`, `tree_depth`, and</span></span>
<span id="cb86-619"><a href="#cb86-619" aria-hidden="true" tabindex="-1"></a><span class="in"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb86-620"><a href="#cb86-620" aria-hidden="true" tabindex="-1"></a><span class="in"># optimize just `cost_complexity` and `tree_depth`.</span></span>
<span id="cb86-621"><a href="#cb86-621" aria-hidden="true" tabindex="-1"></a><span class="in">cs_bag$model &lt;-</span></span>
<span id="cb86-622"><a href="#cb86-622" aria-hidden="true" tabindex="-1"></a><span class="in">  bag_tree(</span></span>
<span id="cb86-623"><a href="#cb86-623" aria-hidden="true" tabindex="-1"></a><span class="in">    cost_complexity = tune(),</span></span>
<span id="cb86-624"><a href="#cb86-624" aria-hidden="true" tabindex="-1"></a><span class="in">    tree_depth = tune()</span></span>
<span id="cb86-625"><a href="#cb86-625" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-626"><a href="#cb86-626" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("rpart") %&gt;%</span></span>
<span id="cb86-627"><a href="#cb86-627" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("regression")</span></span>
<span id="cb86-628"><a href="#cb86-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-629"><a href="#cb86-629" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-630"><a href="#cb86-630" aria-hidden="true" tabindex="-1"></a><span class="in">cs_bag$workflow &lt;-</span></span>
<span id="cb86-631"><a href="#cb86-631" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-632"><a href="#cb86-632" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(cs_bag$model) %&gt;%</span></span>
<span id="cb86-633"><a href="#cb86-633" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Sales ~ .)</span></span>
<span id="cb86-634"><a href="#cb86-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-635"><a href="#cb86-635" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-636"><a href="#cb86-636" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-637"><a href="#cb86-637" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-638"><a href="#cb86-638" aria-hidden="true" tabindex="-1"></a><span class="in">cs_bag$tune_grid &lt;-</span></span>
<span id="cb86-639"><a href="#cb86-639" aria-hidden="true" tabindex="-1"></a><span class="in">  cs_bag$workflow %&gt;%</span></span>
<span id="cb86-640"><a href="#cb86-640" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-641"><a href="#cb86-641" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(cs_train, v = 10), </span></span>
<span id="cb86-642"><a href="#cb86-642" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(cost_complexity(), tree_depth(), levels = 5)</span></span>
<span id="cb86-643"><a href="#cb86-643" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-644"><a href="#cb86-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-645"><a href="#cb86-645" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb86-646"><a href="#cb86-646" aria-hidden="true" tabindex="-1"></a><span class="in">cs_bag$tune_grid %&gt;% </span></span>
<span id="cb86-647"><a href="#cb86-647" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-648"><a href="#cb86-648" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(tree_depth = factor(tree_depth)) %&gt;%</span></span>
<span id="cb86-649"><a href="#cb86-649" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = cost_complexity, y = mean, color = tree_depth)) +</span></span>
<span id="cb86-650"><a href="#cb86-650" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-651"><a href="#cb86-651" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-652"><a href="#cb86-652" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-653"><a href="#cb86-653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-654"><a href="#cb86-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-655"><a href="#cb86-655" aria-hidden="true" tabindex="-1"></a>The best models in terms of RMSE was the tree depth of 8 and any cp &lt; 5.6E-04.</span>
<span id="cb86-656"><a href="#cb86-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-659"><a href="#cb86-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-660"><a href="#cb86-660" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-661"><a href="#cb86-661" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-662"><a href="#cb86-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-663"><a href="#cb86-663" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of rmse and finalize the model. </span>
<span id="cb86-664"><a href="#cb86-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-667"><a href="#cb86-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-668"><a href="#cb86-668" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_bag<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-669"><a href="#cb86-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-670"><a href="#cb86-670" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-671"><a href="#cb86-671" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_bag<span class="sc">$</span>workflow, cs_bag<span class="sc">$</span>best_tune)</span>
<span id="cb86-672"><a href="#cb86-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-673"><a href="#cb86-673" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-674"><a href="#cb86-674" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-675"><a href="#cb86-675" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-676"><a href="#cb86-676" aria-hidden="true" tabindex="-1"></a>  cs_bag<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-677"><a href="#cb86-677" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span>
<span id="cb86-678"><a href="#cb86-678" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-679"><a href="#cb86-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-680"><a href="#cb86-680" aria-hidden="true" tabindex="-1"></a><span class="in">`collect_metrics()`</span> returns the RMSE, $RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})$ and the model $R^2$. The RMSE of <span class="in">` cs_bag$fit %&gt;% collect_metrics() %&gt;% filter(.metric == "rmse") %&gt;% pull(.estimate) %&gt;% comma(.01)`</span> in the test data set is pretty good considering the standard deviation of <span class="in">`Sales`</span> is <span class="in">` comma(sd(cs_test$Sales), .01)`</span>.</span>
<span id="cb86-681"><a href="#cb86-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-684"><a href="#cb86-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-685"><a href="#cb86-685" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-686"><a href="#cb86-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-687"><a href="#cb86-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-688"><a href="#cb86-688" aria-hidden="true" tabindex="-1"></a>Here is a predicted vs actual plot. </span>
<span id="cb86-689"><a href="#cb86-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-692"><a href="#cb86-692" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-693"><a href="#cb86-693" aria-hidden="true" tabindex="-1"></a>cs_bag<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb86-694"><a href="#cb86-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-695"><a href="#cb86-695" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb86-696"><a href="#cb86-696" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb86-697"><a href="#cb86-697" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb86-698"><a href="#cb86-698" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb86-699"><a href="#cb86-699" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats Bagged Trees, Predicted vs Actual"</span>)</span>
<span id="cb86-700"><a href="#cb86-700" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-701"><a href="#cb86-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-702"><a href="#cb86-702" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random Forests</span></span>
<span id="cb86-703"><a href="#cb86-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-704"><a href="#cb86-704" aria-hidden="true" tabindex="-1"></a>Random forests improve bagged trees by way of a small tweak that de-correlates the trees.  As in bagging, the algorithm builds a number of decision trees on bootstrapped training samples. But when building these decision trees, each time a split in a tree is considered, a random sample of *mtry* predictors is chosen as split candidates from the full set of *p* predictors.  A fresh sample of *mtry* predictors is taken at each split.  Typically $mtry \sim \sqrt{p}$.  Bagged trees are thus a special case of random forests where *mtry = p*.</span>
<span id="cb86-705"><a href="#cb86-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-706"><a href="#cb86-706" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random Forest Classification Tree</span></span>
<span id="cb86-707"><a href="#cb86-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-708"><a href="#cb86-708" aria-hidden="true" tabindex="-1"></a>Leaning by example, I'll predict <span class="in">`Purchase`</span> from the <span class="in">`OJ`</span> data set again, this time using the bagging with <span class="in">`parsnip::rand_forest()`</span>.</span>
<span id="cb86-709"><a href="#cb86-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-710"><a href="#cb86-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-rf-class, cache=TRUE}</span></span>
<span id="cb86-711"><a href="#cb86-711" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf &lt;- list()</span></span>
<span id="cb86-712"><a href="#cb86-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-713"><a href="#cb86-713" aria-hidden="true" tabindex="-1"></a><span class="in"># `rand_forest` has 3 hyperparameters (`mtry`, `trees`, and</span></span>
<span id="cb86-714"><a href="#cb86-714" aria-hidden="true" tabindex="-1"></a><span class="in"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb86-715"><a href="#cb86-715" aria-hidden="true" tabindex="-1"></a><span class="in"># optimize just `trees` and `min_n`.</span></span>
<span id="cb86-716"><a href="#cb86-716" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf$model &lt;-</span></span>
<span id="cb86-717"><a href="#cb86-717" aria-hidden="true" tabindex="-1"></a><span class="in">  rand_forest(</span></span>
<span id="cb86-718"><a href="#cb86-718" aria-hidden="true" tabindex="-1"></a><span class="in">    trees = tune(),</span></span>
<span id="cb86-719"><a href="#cb86-719" aria-hidden="true" tabindex="-1"></a><span class="in">    min_n = tune()</span></span>
<span id="cb86-720"><a href="#cb86-720" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-721"><a href="#cb86-721" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("ranger") %&gt;%</span></span>
<span id="cb86-722"><a href="#cb86-722" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("classification")</span></span>
<span id="cb86-723"><a href="#cb86-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-724"><a href="#cb86-724" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-725"><a href="#cb86-725" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf$workflow &lt;-</span></span>
<span id="cb86-726"><a href="#cb86-726" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-727"><a href="#cb86-727" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(oj_rf$model) %&gt;%</span></span>
<span id="cb86-728"><a href="#cb86-728" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Purchase ~ .)</span></span>
<span id="cb86-729"><a href="#cb86-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-730"><a href="#cb86-730" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-731"><a href="#cb86-731" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-732"><a href="#cb86-732" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-733"><a href="#cb86-733" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf$tune_grid &lt;-</span></span>
<span id="cb86-734"><a href="#cb86-734" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_rf$workflow %&gt;%</span></span>
<span id="cb86-735"><a href="#cb86-735" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-736"><a href="#cb86-736" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(oj_train, v = 10), </span></span>
<span id="cb86-737"><a href="#cb86-737" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(trees(), min_n(), levels = 5)</span></span>
<span id="cb86-738"><a href="#cb86-738" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-739"><a href="#cb86-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-740"><a href="#cb86-740" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb86-741"><a href="#cb86-741" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf$tune_grid %&gt;% </span></span>
<span id="cb86-742"><a href="#cb86-742" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-743"><a href="#cb86-743" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(trees = factor(trees)) %&gt;%</span></span>
<span id="cb86-744"><a href="#cb86-744" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = min_n, y = mean, color = trees)) +</span></span>
<span id="cb86-745"><a href="#cb86-745" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-746"><a href="#cb86-746" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-747"><a href="#cb86-747" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-748"><a href="#cb86-748" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-749"><a href="#cb86-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-750"><a href="#cb86-750" aria-hidden="true" tabindex="-1"></a>The best models in terms of accuracy and ROC was the trees of 1000 and any minimum node size of 40.</span>
<span id="cb86-751"><a href="#cb86-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-754"><a href="#cb86-754" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-755"><a href="#cb86-755" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb86-756"><a href="#cb86-756" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-757"><a href="#cb86-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-758"><a href="#cb86-758" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of accuracy and finalize the model.</span>
<span id="cb86-759"><a href="#cb86-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-762"><a href="#cb86-762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-763"><a href="#cb86-763" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_rf<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb86-764"><a href="#cb86-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-765"><a href="#cb86-765" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-766"><a href="#cb86-766" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_rf<span class="sc">$</span>workflow, oj_rf<span class="sc">$</span>best_tune)</span>
<span id="cb86-767"><a href="#cb86-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-768"><a href="#cb86-768" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-769"><a href="#cb86-769" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-770"><a href="#cb86-770" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-771"><a href="#cb86-771" aria-hidden="true" tabindex="-1"></a>  oj_rf<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-772"><a href="#cb86-772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span>
<span id="cb86-773"><a href="#cb86-773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-774"><a href="#cb86-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-775"><a href="#cb86-775" aria-hidden="true" tabindex="-1"></a>There is no single tree to visualize, and you can't even produce a VIP. Let's look at the performance on the holdout data set. <span class="in">`collect_metrics()`</span> shows the accuracy and ROC AUC metrics. The accuracy is slightly lower than the single tree, but ROC AUC is higher than both the single tree and bagged trees.</span>
<span id="cb86-776"><a href="#cb86-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-779"><a href="#cb86-779" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-780"><a href="#cb86-780" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-781"><a href="#cb86-781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-782"><a href="#cb86-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-783"><a href="#cb86-783" aria-hidden="true" tabindex="-1"></a>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve. The confusion matrix calculates the model performance predicting on the holdout testing data set.</span>
<span id="cb86-784"><a href="#cb86-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-785"><a href="#cb86-785" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb86-786"><a href="#cb86-786" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf$confmat &lt;-</span></span>
<span id="cb86-787"><a href="#cb86-787" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_rf$fit %&gt;% </span></span>
<span id="cb86-788"><a href="#cb86-788" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_predictions() %&gt;% </span></span>
<span id="cb86-789"><a href="#cb86-789" aria-hidden="true" tabindex="-1"></a><span class="in">  conf_mat(truth = Purchase, estimate = .pred_class)</span></span>
<span id="cb86-790"><a href="#cb86-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-791"><a href="#cb86-791" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf$confmat</span></span>
<span id="cb86-792"><a href="#cb86-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-793"><a href="#cb86-793" aria-hidden="true" tabindex="-1"></a><span class="in">summary(oj_rf$confmat)</span></span>
<span id="cb86-794"><a href="#cb86-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-795"><a href="#cb86-795" aria-hidden="true" tabindex="-1"></a><span class="in">oj_rf$fit %&gt;% </span></span>
<span id="cb86-796"><a href="#cb86-796" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_predictions() %&gt;% </span></span>
<span id="cb86-797"><a href="#cb86-797" aria-hidden="true" tabindex="-1"></a><span class="in">  select(Purchase, .pred_class) %&gt;%</span></span>
<span id="cb86-798"><a href="#cb86-798" aria-hidden="true" tabindex="-1"></a><span class="in">  plot(</span></span>
<span id="cb86-799"><a href="#cb86-799" aria-hidden="true" tabindex="-1"></a><span class="in">    main = "Random Forest: Predicted vs. Actual",</span></span>
<span id="cb86-800"><a href="#cb86-800" aria-hidden="true" tabindex="-1"></a><span class="in">    xlab = "Actual",</span></span>
<span id="cb86-801"><a href="#cb86-801" aria-hidden="true" tabindex="-1"></a><span class="in">    ylab = "Predicted"</span></span>
<span id="cb86-802"><a href="#cb86-802" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-803"><a href="#cb86-803" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-804"><a href="#cb86-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-805"><a href="#cb86-805" aria-hidden="true" tabindex="-1"></a>The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. The AUC on the holdout set is <span class="in">`r oj_rf$fit %&gt;% collect_predictions() %&gt;% yardstick::roc_auc(Purchase, .pred_CH) %&gt;% pull(.estimate) %&gt;% comma(.001)`</span>.</span>
<span id="cb86-806"><a href="#cb86-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-809"><a href="#cb86-809" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-810"><a href="#cb86-810" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-811"><a href="#cb86-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-812"><a href="#cb86-812" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-813"><a href="#cb86-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-814"><a href="#cb86-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Random Forest ROC Curve"</span>)</span>
<span id="cb86-815"><a href="#cb86-815" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-816"><a href="#cb86-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-817"><a href="#cb86-817" aria-hidden="true" tabindex="-1"></a>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value. </span>
<span id="cb86-818"><a href="#cb86-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-821"><a href="#cb86-821" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-822"><a href="#cb86-822" aria-hidden="true" tabindex="-1"></a>oj_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-823"><a href="#cb86-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-824"><a href="#cb86-824" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-825"><a href="#cb86-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-826"><a href="#cb86-826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ Random Forest Gain Curve"</span>)</span>
<span id="cb86-827"><a href="#cb86-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-828"><a href="#cb86-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-829"><a href="#cb86-829" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random Forest Regression Tree</span></span>
<span id="cb86-830"><a href="#cb86-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-831"><a href="#cb86-831" aria-hidden="true" tabindex="-1"></a>I'll predict <span class="in">`Sales`</span> from the <span class="in">`Carseats`</span> data set again, this time with <span class="in">`parsnip::rand_forest()`</span>.</span>
<span id="cb86-832"><a href="#cb86-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-833"><a href="#cb86-833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-rf-reg, cache=TRUE}</span></span>
<span id="cb86-834"><a href="#cb86-834" aria-hidden="true" tabindex="-1"></a><span class="in">cs_rf &lt;- list()</span></span>
<span id="cb86-835"><a href="#cb86-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-836"><a href="#cb86-836" aria-hidden="true" tabindex="-1"></a><span class="in"># `rand_forest` has 3 hyperparameters (`mtry`, `trees`, and</span></span>
<span id="cb86-837"><a href="#cb86-837" aria-hidden="true" tabindex="-1"></a><span class="in"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb86-838"><a href="#cb86-838" aria-hidden="true" tabindex="-1"></a><span class="in"># optimize just `trees` and `min_n`.</span></span>
<span id="cb86-839"><a href="#cb86-839" aria-hidden="true" tabindex="-1"></a><span class="in">cs_rf$model &lt;-</span></span>
<span id="cb86-840"><a href="#cb86-840" aria-hidden="true" tabindex="-1"></a><span class="in">  rand_forest(</span></span>
<span id="cb86-841"><a href="#cb86-841" aria-hidden="true" tabindex="-1"></a><span class="in">    trees = tune(),</span></span>
<span id="cb86-842"><a href="#cb86-842" aria-hidden="true" tabindex="-1"></a><span class="in">    min_n = tune()</span></span>
<span id="cb86-843"><a href="#cb86-843" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-844"><a href="#cb86-844" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("ranger") %&gt;%</span></span>
<span id="cb86-845"><a href="#cb86-845" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("regression")</span></span>
<span id="cb86-846"><a href="#cb86-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-847"><a href="#cb86-847" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-848"><a href="#cb86-848" aria-hidden="true" tabindex="-1"></a><span class="in">cs_rf$workflow &lt;-</span></span>
<span id="cb86-849"><a href="#cb86-849" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-850"><a href="#cb86-850" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(cs_rf$model) %&gt;%</span></span>
<span id="cb86-851"><a href="#cb86-851" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Sales ~ .)</span></span>
<span id="cb86-852"><a href="#cb86-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-853"><a href="#cb86-853" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-854"><a href="#cb86-854" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-855"><a href="#cb86-855" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-856"><a href="#cb86-856" aria-hidden="true" tabindex="-1"></a><span class="in">cs_rf$tune_grid &lt;-</span></span>
<span id="cb86-857"><a href="#cb86-857" aria-hidden="true" tabindex="-1"></a><span class="in">  cs_rf$workflow %&gt;%</span></span>
<span id="cb86-858"><a href="#cb86-858" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-859"><a href="#cb86-859" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(cs_train, v = 10), </span></span>
<span id="cb86-860"><a href="#cb86-860" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(trees(), min_n(), levels = 5)</span></span>
<span id="cb86-861"><a href="#cb86-861" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-862"><a href="#cb86-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-863"><a href="#cb86-863" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb86-864"><a href="#cb86-864" aria-hidden="true" tabindex="-1"></a><span class="in">cs_rf$tune_grid %&gt;% </span></span>
<span id="cb86-865"><a href="#cb86-865" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-866"><a href="#cb86-866" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(trees = factor(trees)) %&gt;%</span></span>
<span id="cb86-867"><a href="#cb86-867" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = min_n, y = mean, color = trees)) +</span></span>
<span id="cb86-868"><a href="#cb86-868" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-869"><a href="#cb86-869" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-870"><a href="#cb86-870" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-871"><a href="#cb86-871" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-872"><a href="#cb86-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-873"><a href="#cb86-873" aria-hidden="true" tabindex="-1"></a>The best models in terms of RMSE was 2000 tree with at least 2 data points per node.</span>
<span id="cb86-874"><a href="#cb86-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-877"><a href="#cb86-877" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-878"><a href="#cb86-878" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-879"><a href="#cb86-879" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-880"><a href="#cb86-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-881"><a href="#cb86-881" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of rmse and finalize the model. </span>
<span id="cb86-882"><a href="#cb86-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-885"><a href="#cb86-885" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-886"><a href="#cb86-886" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_rf<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-887"><a href="#cb86-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-888"><a href="#cb86-888" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-889"><a href="#cb86-889" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_rf<span class="sc">$</span>workflow, cs_rf<span class="sc">$</span>best_tune)</span>
<span id="cb86-890"><a href="#cb86-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-891"><a href="#cb86-891" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-892"><a href="#cb86-892" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-893"><a href="#cb86-893" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-894"><a href="#cb86-894" aria-hidden="true" tabindex="-1"></a>  cs_rf<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-895"><a href="#cb86-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span>
<span id="cb86-896"><a href="#cb86-896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-897"><a href="#cb86-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-898"><a href="#cb86-898" aria-hidden="true" tabindex="-1"></a><span class="in">`collect_metrics()`</span> returns the RMSE, $RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})$ and the model $R^2$. The RMSE of <span class="in">`r cs_rf$fit %&gt;% collect_metrics() %&gt;% filter(.metric == "rmse") %&gt;% pull(.estimate) %&gt;% comma(.01)`</span> in the test data set is pretty good considering the standard deviation of <span class="in">`Sales`</span> is <span class="in">`r comma(sd(cs_test$Sales), .01)`</span>.</span>
<span id="cb86-899"><a href="#cb86-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-902"><a href="#cb86-902" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-903"><a href="#cb86-903" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-904"><a href="#cb86-904" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-905"><a href="#cb86-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-906"><a href="#cb86-906" aria-hidden="true" tabindex="-1"></a>Here is a predicted vs actual plot. </span>
<span id="cb86-907"><a href="#cb86-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-910"><a href="#cb86-910" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-911"><a href="#cb86-911" aria-hidden="true" tabindex="-1"></a>cs_rf<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb86-912"><a href="#cb86-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-913"><a href="#cb86-913" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb86-914"><a href="#cb86-914" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb86-915"><a href="#cb86-915" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb86-916"><a href="#cb86-916" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb86-917"><a href="#cb86-917" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats Random Forest, Predicted vs Actual"</span>)</span>
<span id="cb86-918"><a href="#cb86-918" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-919"><a href="#cb86-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-920"><a href="#cb86-920" aria-hidden="true" tabindex="-1"></a><span class="fu">## Gradient Boosting</span></span>
<span id="cb86-921"><a href="#cb86-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-922"><a href="#cb86-922" aria-hidden="true" tabindex="-1"></a>**Note**: I learned gradient boosting from <span class="co">[</span><span class="ot">explained.ai</span><span class="co">](https://explained.ai/gradient-boosting/L2-loss.html)</span>.</span>
<span id="cb86-923"><a href="#cb86-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-924"><a href="#cb86-924" aria-hidden="true" tabindex="-1"></a>Gradient boosting machine (GBM) is an additive modeling algorithm that gradually builds a composite model by iteratively adding *M* weak sub-models based on the performance of the prior iteration's composite,</span>
<span id="cb86-925"><a href="#cb86-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-926"><a href="#cb86-926" aria-hidden="true" tabindex="-1"></a>$$F_M(x) = \sum_m^M f_m(x).$$</span>
<span id="cb86-927"><a href="#cb86-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-928"><a href="#cb86-928" aria-hidden="true" tabindex="-1"></a>The idea is to fit a weak model, then replace the response values with the residuals from that model, and fit another model. Adding the residual prediction model to the original response prediction model produces a more accurate model. GBM repeats this process over and over, running new models to predict the residuals of the previous composite models, and adding the results to produce new composites. With each iteration, the model becomes stronger and stronger. The successive trees are usually weighted to slow down the learning rate. "Shrinkage" reduces the influence of each individual tree and leaves space for future trees to improve the model.</span>
<span id="cb86-929"><a href="#cb86-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-930"><a href="#cb86-930" aria-hidden="true" tabindex="-1"></a>$$F_M(x) = f_0 + \eta\sum_{m = 1}^M f_m(x).$$</span>
<span id="cb86-931"><a href="#cb86-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-932"><a href="#cb86-932" aria-hidden="true" tabindex="-1"></a>The smaller the learning rate, $\eta$, the larger the number of trees, $M$. $\eta$ and $M$ are hyperparameters. Other constraints to the trees are usually applied as additional hyperparameters, including, tree depth, number of nodes, minimum observations per split, and minimum improvement to loss.</span>
<span id="cb86-933"><a href="#cb86-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-934"><a href="#cb86-934" aria-hidden="true" tabindex="-1"></a>The name "gradient boosting" refers to the *boosting* of a model with a *gradient*. Each round of training builds a *weak learner* and uses the residuals to calculate a gradient, the partial derivative of the loss function. Gradient boosting "descends the gradient" to adjust the model parameters to reduce the error in the next round of training.</span>
<span id="cb86-935"><a href="#cb86-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-936"><a href="#cb86-936" aria-hidden="true" tabindex="-1"></a>In the case of classification problems, the loss function is the log-loss; for regression problems, the loss function is mean squared error. GBM continues until it reaches maximum number of trees or an acceptable error level.</span>
<span id="cb86-937"><a href="#cb86-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-938"><a href="#cb86-938" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Gradient Boosting Classification Tree</span></span>
<span id="cb86-939"><a href="#cb86-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-940"><a href="#cb86-940" aria-hidden="true" tabindex="-1"></a>Leaning by example, I'll predict <span class="in">`Purchase`</span> from the <span class="in">`OJ`</span> data set again, this time using the bagging with <span class="in">`parsnip::boost_tree()`</span></span>
<span id="cb86-941"><a href="#cb86-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-942"><a href="#cb86-942" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-xgboost-class, cache=TRUE}</span></span>
<span id="cb86-943"><a href="#cb86-943" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb &lt;- list()</span></span>
<span id="cb86-944"><a href="#cb86-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-945"><a href="#cb86-945" aria-hidden="true" tabindex="-1"></a><span class="in"># `boost_tree` has 8 hyperparameters. Let's optimize just `trees` and `min_n`.</span></span>
<span id="cb86-946"><a href="#cb86-946" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb$model &lt;-</span></span>
<span id="cb86-947"><a href="#cb86-947" aria-hidden="true" tabindex="-1"></a><span class="in">  boost_tree(</span></span>
<span id="cb86-948"><a href="#cb86-948" aria-hidden="true" tabindex="-1"></a><span class="in">    trees = tune(),</span></span>
<span id="cb86-949"><a href="#cb86-949" aria-hidden="true" tabindex="-1"></a><span class="in">    min_n = tune()</span></span>
<span id="cb86-950"><a href="#cb86-950" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-951"><a href="#cb86-951" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("xgboost") %&gt;%</span></span>
<span id="cb86-952"><a href="#cb86-952" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("classification")</span></span>
<span id="cb86-953"><a href="#cb86-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-954"><a href="#cb86-954" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-955"><a href="#cb86-955" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb$workflow &lt;-</span></span>
<span id="cb86-956"><a href="#cb86-956" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-957"><a href="#cb86-957" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(oj_xgb$model) %&gt;%</span></span>
<span id="cb86-958"><a href="#cb86-958" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Purchase ~ .)</span></span>
<span id="cb86-959"><a href="#cb86-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-960"><a href="#cb86-960" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-961"><a href="#cb86-961" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-962"><a href="#cb86-962" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-963"><a href="#cb86-963" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb$tune_grid &lt;-</span></span>
<span id="cb86-964"><a href="#cb86-964" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_xgb$workflow %&gt;%</span></span>
<span id="cb86-965"><a href="#cb86-965" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-966"><a href="#cb86-966" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(oj_train, v = 10), </span></span>
<span id="cb86-967"><a href="#cb86-967" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(trees(), min_n(), levels = 5)</span></span>
<span id="cb86-968"><a href="#cb86-968" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-969"><a href="#cb86-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-970"><a href="#cb86-970" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb86-971"><a href="#cb86-971" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb$tune_grid %&gt;% </span></span>
<span id="cb86-972"><a href="#cb86-972" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-973"><a href="#cb86-973" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(trees = factor(trees)) %&gt;%</span></span>
<span id="cb86-974"><a href="#cb86-974" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = min_n, y = mean, color = trees)) +</span></span>
<span id="cb86-975"><a href="#cb86-975" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-976"><a href="#cb86-976" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-977"><a href="#cb86-977" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-978"><a href="#cb86-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-979"><a href="#cb86-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-980"><a href="#cb86-980" aria-hidden="true" tabindex="-1"></a>The best models in terms of accuracy and ROC was the trees of 1000 and any minimum node size of 40.</span>
<span id="cb86-981"><a href="#cb86-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-984"><a href="#cb86-984" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-985"><a href="#cb86-985" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb86-986"><a href="#cb86-986" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-987"><a href="#cb86-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-988"><a href="#cb86-988" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of accuracy and finalize the model.</span>
<span id="cb86-989"><a href="#cb86-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-992"><a href="#cb86-992" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-993"><a href="#cb86-993" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(oj_xgb<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb86-994"><a href="#cb86-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-995"><a href="#cb86-995" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-996"><a href="#cb86-996" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(oj_xgb<span class="sc">$</span>workflow, oj_xgb<span class="sc">$</span>best_tune)</span>
<span id="cb86-997"><a href="#cb86-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-998"><a href="#cb86-998" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-999"><a href="#cb86-999" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-1000"><a href="#cb86-1000" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-1001"><a href="#cb86-1001" aria-hidden="true" tabindex="-1"></a>  oj_xgb<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-1002"><a href="#cb86-1002" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(oj_split)</span>
<span id="cb86-1003"><a href="#cb86-1003" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1004"><a href="#cb86-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1005"><a href="#cb86-1005" aria-hidden="true" tabindex="-1"></a>There is no single tree to visualize, and you can't even produce a VIP. Let's look at the performance on the holdout data set. <span class="in">`collect_metrics()`</span> shows the accuracy and ROC AUC metrics.</span>
<span id="cb86-1006"><a href="#cb86-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1009"><a href="#cb86-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1010"><a href="#cb86-1010" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-1011"><a href="#cb86-1011" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1012"><a href="#cb86-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1013"><a href="#cb86-1013" aria-hidden="true" tabindex="-1"></a>You can explore the performance by calculating the full confusion matrix and visualizing the ROC curve. The confusion matrix calculates the model performance predicting on the holdout testing data set.</span>
<span id="cb86-1014"><a href="#cb86-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1015"><a href="#cb86-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb86-1016"><a href="#cb86-1016" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb$confmat &lt;-</span></span>
<span id="cb86-1017"><a href="#cb86-1017" aria-hidden="true" tabindex="-1"></a><span class="in">  oj_xgb$fit %&gt;% </span></span>
<span id="cb86-1018"><a href="#cb86-1018" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_predictions() %&gt;% </span></span>
<span id="cb86-1019"><a href="#cb86-1019" aria-hidden="true" tabindex="-1"></a><span class="in">  conf_mat(truth = Purchase, estimate = .pred_class)</span></span>
<span id="cb86-1020"><a href="#cb86-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1021"><a href="#cb86-1021" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb$confmat</span></span>
<span id="cb86-1022"><a href="#cb86-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1023"><a href="#cb86-1023" aria-hidden="true" tabindex="-1"></a><span class="in">summary(oj_xgb$confmat)</span></span>
<span id="cb86-1024"><a href="#cb86-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1025"><a href="#cb86-1025" aria-hidden="true" tabindex="-1"></a><span class="in">oj_xgb$fit %&gt;% </span></span>
<span id="cb86-1026"><a href="#cb86-1026" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_predictions() %&gt;% </span></span>
<span id="cb86-1027"><a href="#cb86-1027" aria-hidden="true" tabindex="-1"></a><span class="in">  select(Purchase, .pred_class) %&gt;%</span></span>
<span id="cb86-1028"><a href="#cb86-1028" aria-hidden="true" tabindex="-1"></a><span class="in">  plot(</span></span>
<span id="cb86-1029"><a href="#cb86-1029" aria-hidden="true" tabindex="-1"></a><span class="in">    main = "XGBoost: Predicted vs. Actual",</span></span>
<span id="cb86-1030"><a href="#cb86-1030" aria-hidden="true" tabindex="-1"></a><span class="in">    xlab = "Actual",</span></span>
<span id="cb86-1031"><a href="#cb86-1031" aria-hidden="true" tabindex="-1"></a><span class="in">    ylab = "Predicted"</span></span>
<span id="cb86-1032"><a href="#cb86-1032" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-1033"><a href="#cb86-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1034"><a href="#cb86-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1035"><a href="#cb86-1035" aria-hidden="true" tabindex="-1"></a>The ROC curve is a plot of the true positive rate (TPR, sensitivity) versus the false positive rate (FPR, 1 - specificity) for a set of thresholds. The AUC on the holdout set is <span class="in">`r oj_xgb$fit %&gt;% collect_predictions() %&gt;% yardstick::roc_auc(Purchase, .pred_CH) %&gt;% pull(.estimate) %&gt;% comma(.001)`</span>.</span>
<span id="cb86-1036"><a href="#cb86-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1039"><a href="#cb86-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1040"><a href="#cb86-1040" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-1041"><a href="#cb86-1041" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-1042"><a href="#cb86-1042" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">roc_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-1043"><a href="#cb86-1043" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-1044"><a href="#cb86-1044" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ XGBoost ROC Curve"</span>)</span>
<span id="cb86-1045"><a href="#cb86-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1046"><a href="#cb86-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1047"><a href="#cb86-1047" aria-hidden="true" tabindex="-1"></a>The gain curve plots the cumulative summed true outcome versus the fraction of items seen when sorted by the predicted value. </span>
<span id="cb86-1048"><a href="#cb86-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1051"><a href="#cb86-1051" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1052"><a href="#cb86-1052" aria-hidden="true" tabindex="-1"></a>oj_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb86-1053"><a href="#cb86-1053" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-1054"><a href="#cb86-1054" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">gain_curve</span>(Purchase, .pred_CH) <span class="sc">%&gt;%</span></span>
<span id="cb86-1055"><a href="#cb86-1055" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb86-1056"><a href="#cb86-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OJ XGBoost Gain Curve"</span>)</span>
<span id="cb86-1057"><a href="#cb86-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1058"><a href="#cb86-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1059"><a href="#cb86-1059" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Gradient Boosting Regression Tree</span></span>
<span id="cb86-1060"><a href="#cb86-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1061"><a href="#cb86-1061" aria-hidden="true" tabindex="-1"></a>I'll predict <span class="in">`Sales`</span> from the <span class="in">`Carseats`</span> data set again, this time with <span class="in">`parsnip::rand_forest()`</span>.</span>
<span id="cb86-1062"><a href="#cb86-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1063"><a href="#cb86-1063" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fit-xgboost-reg, cache=TRUE}</span></span>
<span id="cb86-1064"><a href="#cb86-1064" aria-hidden="true" tabindex="-1"></a><span class="in">cs_xgb &lt;- list()</span></span>
<span id="cb86-1065"><a href="#cb86-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1066"><a href="#cb86-1066" aria-hidden="true" tabindex="-1"></a><span class="in"># `rand_forest` has 3 hyperparameters (`mtry`, `trees`, and</span></span>
<span id="cb86-1067"><a href="#cb86-1067" aria-hidden="true" tabindex="-1"></a><span class="in"># `min_n`). Set their value to `tune()` if you want to optimize any one. Let's</span></span>
<span id="cb86-1068"><a href="#cb86-1068" aria-hidden="true" tabindex="-1"></a><span class="in"># optimize just `trees` and `min_n`.</span></span>
<span id="cb86-1069"><a href="#cb86-1069" aria-hidden="true" tabindex="-1"></a><span class="in">cs_xgb$model &lt;-</span></span>
<span id="cb86-1070"><a href="#cb86-1070" aria-hidden="true" tabindex="-1"></a><span class="in">  boost_tree(</span></span>
<span id="cb86-1071"><a href="#cb86-1071" aria-hidden="true" tabindex="-1"></a><span class="in">    trees = tune(),</span></span>
<span id="cb86-1072"><a href="#cb86-1072" aria-hidden="true" tabindex="-1"></a><span class="in">    min_n = tune()</span></span>
<span id="cb86-1073"><a href="#cb86-1073" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb86-1074"><a href="#cb86-1074" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("xgboost") %&gt;%</span></span>
<span id="cb86-1075"><a href="#cb86-1075" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("regression")</span></span>
<span id="cb86-1076"><a href="#cb86-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1077"><a href="#cb86-1077" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune a model using the workflow framework.</span></span>
<span id="cb86-1078"><a href="#cb86-1078" aria-hidden="true" tabindex="-1"></a><span class="in">cs_xgb$workflow &lt;-</span></span>
<span id="cb86-1079"><a href="#cb86-1079" aria-hidden="true" tabindex="-1"></a><span class="in">  workflow() %&gt;%</span></span>
<span id="cb86-1080"><a href="#cb86-1080" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(cs_xgb$model) %&gt;%</span></span>
<span id="cb86-1081"><a href="#cb86-1081" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(Sales ~ .)</span></span>
<span id="cb86-1082"><a href="#cb86-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1083"><a href="#cb86-1083" aria-hidden="true" tabindex="-1"></a><span class="in"># Tune the model with 10-fold CV using a regular grid of cost complexity values.</span></span>
<span id="cb86-1084"><a href="#cb86-1084" aria-hidden="true" tabindex="-1"></a><span class="in"># With 2 hyperparameters and 5 levels, the grid has 5^2=25 combinations. That</span></span>
<span id="cb86-1085"><a href="#cb86-1085" aria-hidden="true" tabindex="-1"></a><span class="in"># means the tuning exercise will fit 25 models to each of 10 folds = 250 fits.</span></span>
<span id="cb86-1086"><a href="#cb86-1086" aria-hidden="true" tabindex="-1"></a><span class="in">cs_xgb$tune_grid &lt;-</span></span>
<span id="cb86-1087"><a href="#cb86-1087" aria-hidden="true" tabindex="-1"></a><span class="in">  cs_xgb$workflow %&gt;%</span></span>
<span id="cb86-1088"><a href="#cb86-1088" aria-hidden="true" tabindex="-1"></a><span class="in">  tune_grid(</span></span>
<span id="cb86-1089"><a href="#cb86-1089" aria-hidden="true" tabindex="-1"></a><span class="in">    resamples = vfold_cv(cs_train, v = 10), </span></span>
<span id="cb86-1090"><a href="#cb86-1090" aria-hidden="true" tabindex="-1"></a><span class="in">    grid = grid_regular(trees(), min_n(), levels = 5)</span></span>
<span id="cb86-1091"><a href="#cb86-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb86-1092"><a href="#cb86-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1093"><a href="#cb86-1093" aria-hidden="true" tabindex="-1"></a><span class="in"># `collect_metrics()` returns two metrics: accuracy and ROC-AUC.</span></span>
<span id="cb86-1094"><a href="#cb86-1094" aria-hidden="true" tabindex="-1"></a><span class="in">cs_xgb$tune_grid %&gt;% </span></span>
<span id="cb86-1095"><a href="#cb86-1095" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;%</span></span>
<span id="cb86-1096"><a href="#cb86-1096" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(trees = factor(trees)) %&gt;%</span></span>
<span id="cb86-1097"><a href="#cb86-1097" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = min_n, y = mean, color = trees)) +</span></span>
<span id="cb86-1098"><a href="#cb86-1098" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(linewidth = 1.5, alpha = .6) +</span></span>
<span id="cb86-1099"><a href="#cb86-1099" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(.metric), scales = "free") +</span></span>
<span id="cb86-1100"><a href="#cb86-1100" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10()</span></span>
<span id="cb86-1101"><a href="#cb86-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1102"><a href="#cb86-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1103"><a href="#cb86-1103" aria-hidden="true" tabindex="-1"></a>The best models in terms of RMSE was 500 trees with at least 21 data points per node.</span>
<span id="cb86-1104"><a href="#cb86-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1107"><a href="#cb86-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1108"><a href="#cb86-1108" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>tune <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-1109"><a href="#cb86-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1110"><a href="#cb86-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1111"><a href="#cb86-1111" aria-hidden="true" tabindex="-1"></a>Select the best model in terms of rmse and finalize the model. </span>
<span id="cb86-1112"><a href="#cb86-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1115"><a href="#cb86-1115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1116"><a href="#cb86-1116" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>best_tune <span class="ot">&lt;-</span> <span class="fu">select_best</span>(cs_xgb<span class="sc">$</span>tune_grid, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb86-1117"><a href="#cb86-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1118"><a href="#cb86-1118" aria-hidden="true" tabindex="-1"></a><span class="co"># `finalize_workflow()` applies the tuning parameters to the workflow.</span></span>
<span id="cb86-1119"><a href="#cb86-1119" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(cs_xgb<span class="sc">$</span>workflow, cs_xgb<span class="sc">$</span>best_tune)</span>
<span id="cb86-1120"><a href="#cb86-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1121"><a href="#cb86-1121" aria-hidden="true" tabindex="-1"></a><span class="co"># last_fit() fits the model with the full training set and evaluates it on the </span></span>
<span id="cb86-1122"><a href="#cb86-1122" aria-hidden="true" tabindex="-1"></a><span class="co"># testing data.</span></span>
<span id="cb86-1123"><a href="#cb86-1123" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>fit <span class="ot">&lt;-</span></span>
<span id="cb86-1124"><a href="#cb86-1124" aria-hidden="true" tabindex="-1"></a>  cs_rf<span class="sc">$</span>final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb86-1125"><a href="#cb86-1125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cs_split)</span>
<span id="cb86-1126"><a href="#cb86-1126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1127"><a href="#cb86-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1128"><a href="#cb86-1128" aria-hidden="true" tabindex="-1"></a><span class="in">`collect_metrics()`</span> returns the RMSE, $RMSE = \sqrt{(1/2) \sum{(actual - pred)^2}})$ and the model $R^2$. The RMSE of <span class="in">`r cs_xgb$fit %&gt;% collect_metrics() %&gt;% filter(.metric == "rmse") %&gt;% pull(.estimate) %&gt;% comma(.01)`</span> in the test data set is pretty good considering the standard deviation of <span class="in">`Sales`</span> is <span class="in">`r comma(sd(cs_test$Sales), .01)`</span>.</span>
<span id="cb86-1129"><a href="#cb86-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1132"><a href="#cb86-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1133"><a href="#cb86-1133" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb86-1134"><a href="#cb86-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1135"><a href="#cb86-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1136"><a href="#cb86-1136" aria-hidden="true" tabindex="-1"></a>Here is a predicted vs actual plot. </span>
<span id="cb86-1137"><a href="#cb86-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1140"><a href="#cb86-1140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1141"><a href="#cb86-1141" aria-hidden="true" tabindex="-1"></a>cs_xgb<span class="sc">$</span>fit <span class="sc">%&gt;%</span> </span>
<span id="cb86-1142"><a href="#cb86-1142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-1143"><a href="#cb86-1143" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sales, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb86-1144"><a href="#cb86-1144" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"cadetblue"</span>) <span class="sc">+</span></span>
<span id="cb86-1145"><a href="#cb86-1145" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y~x"</span>) <span class="sc">+</span></span>
<span id="cb86-1146"><a href="#cb86-1146" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb86-1147"><a href="#cb86-1147" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Carseats Random Forest, Predicted vs Actual"</span>)</span>
<span id="cb86-1148"><a href="#cb86-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>